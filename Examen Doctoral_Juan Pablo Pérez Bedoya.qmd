---
title: "Examen Doctoral: Efecto de la edad, el período y la cohorte de nacimiento sobre la tasa de mortalidad por diabetes mellitus en Colombia, 1983-2022. Un estudio transversal analítico"
author: "Juan Pablo Pérez Bedoya. Estudiante Doctorado en Epidemiología. Cohorte IX"
format: html
editor: visual
toc: true
theme: flatly
self-contained: true
---

## Pasos iniciales

**Cargar Paquetes y librerias:**

-   Paquetes

```{r, message=FALSE,warning=FALSE}
#if(!("APCG1" %in% installed.packages())){devtools::install("./APCG1")}
#install.packages("APCtools")
#install.packages("APCI")
#install.packages("apc")
#install.packages("bamp")
#install.packages("StanMoMo")
#install.packages("readxl")
#install.packages("summarytools")
#install.packages("gtsummary")
#install.packages("ggplot")
#install.packages("plotly")
#install.packages("dplyr")
#install.packages("gridExtra")
#install.packages("tidyverse")
```

-   Librerias

```{r,message=FALSE}
library(APCG1)
library(APCtools)
library(APCI)
library(apc)
library(bamp)
library(StanMoMo)
library(readxl)
library(summarytools)
library(gtsummary)
library(ggplot2)
library(plotly)
library(dplyr)
library(gridExtra)
library(tidyverse)
```

**Cargar bases de datos:**

-   Bases de datos para diabetes mellitus en población general (DM)

*Base de datos en formato largo*: Esta base de datos incluye los grupos de período, los grupos de edad, los grupos de cohorte, el conteo de fallecimientos por diabetes, la población a mitad de período y la tasa cruda de mortalidad de diabetes por cada 100.000 habitantes. Así mismo, incluye las categorías de los grupos de edad, período y cohorte requeridas para algunos gráficos.

```{r}
library(readxl)
bd_long_dm <- read_excel("bd_long_dm.xlsx")
View(bd_long_dm)
```

Oscar

```{r}

bd_long_dm %>% filter(period == 1983) -> check


```

*Base de datos en tabla Lexis para la frecuencia (conteo de casos)*: Esta base de datos incluye el conteo de fallecimientos atribuidos a diabetes mellitus en formato de tabla Lexis según grupos de edad (filas), grupos de período (columnas) y grupos de cohortes de nacimiento (diagonales).

```{r}
bd_lexis_f_dm <- read_xlsx("TABLA_LEXIS_FRECUENCIA_DM.xlsx")
head(bd_lexis_f_dm)
```

*Base de datos en tabla Lexis para la población*: Esta base de datos incluye el conteo de habitantes a partir de las proyecciones y retroproyecciones del Departamento Administrativo Nacional de Estadística de Colombia, en formato de tabla Lexis según grupos de edad (filas), grupos de período (columnas) y grupos de cohorte de nacimiento (diagonales).

```{r}
bd_lexis_p_dm <- read_xlsx("TABLA_LEXIS_POBLACION_GENERAL.xlsx")
head(bd_lexis_p_dm)
```

*Base de datos en tabla Lexis para la tasa de mortalidad por diabetes*: Esta base de datos incluye la tasa cruda de mortalidad de diabetes mellitus por cada 100.000 habitantes, en formato de tabla Lexis según grupos de edad (filas), grupos de período (columnas) y grupos de cohorte de nacimiento (diagonales).

```{r}
bd_lexis_t_dm <- read_xlsx("TABLA_LEXIS_TASA_DM.xlsx")
head(bd_lexis_t_dm)
```

-   Bases de datos para diabetes mellitus según sexo masculino

*Base de datos en formato largo*: Esta base de datos incluye los grupos de período, los grupos de edad, los grupos de cohorte, el conteo de fallecimientos por diabetes para el sexo masculino, la población a mitad de período para el sexo masculino y la tasa cruda de mortalidad de diabetes en hombres por cada 100.000 habitantes. Así mismo, incluye las categorías de los grupos de edad, período y cohorte requeridas para algunos gráficos.

```{r}
bd_long_dm_h <- read_xlsx("bd_long_dm_h.xlsx")
head(bd_long_dm_h)
```

*Base de datos en tabla Lexis para la frecuencia (conteo de casos)*: Esta base de datos incluye el conteo de fallecimientos atribuidos a diabetes mellitus para el sexo masculino en formato de tabla Lexis según grupos de edad (filas), grupos de período (columnas) y grupos de cohortes de nacimiento (diagonales).

```{r}
bd_lexis_f_dm_h <- read_xlsx("TABLA_LEXIS_FRECUENCIA_DM_H.xlsx")
head(bd_lexis_f_dm_h)
```

*Base de datos en tabla Lexis para la población*: Esta base de datos incluye el conteo de habitantes para el sexo masculino a partir de las proyecciones y retroproyecciones del Departamento Administrativo Nacional de Estadística de Colombia, en formato de tabla Lexis según grupos de edad (filas), grupos de período (columnas) y grupos de cohorte de nacimiento (diagonales).

```{r}
bd_lexis_p_dm_h <- read_xlsx("TABLA_LEXIS_POBLACION_DM_H.xlsx")
head(bd_lexis_p_dm_h)
```

*Base de datos en tabla Lexis para la tasa de mortalidad de diabetes*: Esta base de datos incluye la tasa de mortalidad de diabetes mellitus para el sexo masculino por cada 100.000 habitantes, en formato de tabla Lexis según grupos de edad (filas), grupos de período (columnas) y grupos de cohorte de nacimiento (diagonales).

```{r}
bd_lexis_t_dm_h <- read_xlsx("TABLA_LEXIS_TASA_DM_H.xlsx")
head(bd_lexis_t_dm_h)
```

-   Bases de datos para diabetes mellitus según sexo femenino

*Base de datos en formato largo*: Esta base de datos incluye los grupos de período, los grupos de edad, los grupos de cohorte, el conteo de fallecimientos por diabetes para el sexo femenino, la población a mitad de período para el sexo femenino y la tasa de mortalidad de diabetes en mujeres por cada 100.000 habitantes. Así mismo, incluye las categorías de los grupos de edad, período y cohorte requeridas para algunos gráficos.

```{r}
bd_long_dm_m <- read_xlsx("bd_long_dm_m.xlsx")
head(bd_long_dm_m)
```

*Base de datos en tabla Lexis para la frecuencia (conteo de casos)*: Esta base de datos incluye el conteo de fallecimientos atribuidos a diabetes mellitus para el sexo femenino, en formato de tabla Lexis según grupos de edad (filas), grupos de período (columnas) y grupos de cohortes de nacimiento (diagonales).

```{r}
bd_lexis_f_dm_m <- read_xlsx("TABLA_LEXIS_FRECUENCIA_DM_M.xlsx")
head(bd_lexis_f_dm_m)
```

*Base de datos en tabla Lexis para la población*: Esta base de datos incluye el conteo de habitantes para el sexo femenino a partir de las proyecciones y retroproyecciones del Departamento Administrativo Nacional de Estadística de Colombia, en formato de tabla Lexis según grupos de edad (filas), grupos de período (columnas) y grupos de cohorte de nacimiento (diagonales).

```{r}
bd_lexis_p_dm_m <- read_xlsx("TABLA_LEXIS_POBLACION_DM_M.xlsx")
head(bd_lexis_p_dm_m)
```

*Base de datos en tabla Lexis para la tasa de mortalidad de diabetes*: Esta base de datos incluye la tasa de mortalidad de diabetes mellitus para el sexo femenino por cada 100.000 habitantes, en formato de tabla Lexis según grupos de edad (filas), grupos de período (columnas) y grupos de cohorte de nacimiento (diagonales).

```{r}
bd_lexis_t_dm_m <- read_xlsx("TABLA_LEXIS_TASA_DM_M.xlsx")
head(bd_lexis_t_dm_m)
```

**Naturaleza de las variables:**

-   Variables de naturaleza cuantitativa (Tipo numeric)

```{r}
class(bd_long_dm$deaths)
class(bd_long_dm$mortality_rate)
class(bd_long_dm$age)
class(bd_long_dm$period)
class(bd_long_dm$cohort)
class(bd_long_dm_h$deaths)
class(bd_long_dm_h$mortality_rate)
class(bd_long_dm_h$age)
class(bd_long_dm_h$period)
class(bd_long_dm_h$cohort)
class(bd_long_dm_m$deaths)
class(bd_long_dm_m$mortality_rate)
class(bd_long_dm_m$age)
class(bd_long_dm_m$period)
class(bd_long_dm_m$cohort)
```

-   Variables de naturaleza cualitativa (Almacenada como tipo character es decir, como cadena de texto)

```{r}
class(bd_long_dm$age_group)
class(bd_long_dm$period_group)
class(bd_long_dm$cohort_group)
class(bd_long_dm_h$age_group)
class(bd_long_dm_h$period_group)
class(bd_long_dm_h$cohort_group)
class(bd_long_dm_m$age_group)
class(bd_long_dm_m$period_group)
class(bd_long_dm_m$cohort_group)
```

**Diccionario de variables:**

+--------------------------------------+------------------------+-------------------+---------------+
| Nombre de variable                   | Naturaleza             | Nivel de medición | Codificación  |
+======================================+========================+===================+===============+
| Variable dependiente: deaths         | Cuantitativa discreta  | Razón             | No aplica     |
+--------------------------------------+------------------------+-------------------+---------------+
| Variable dependiente: mortality_rate | Cuantitativa continua  | Razón             | No aplica     |
+--------------------------------------+------------------------+-------------------+---------------+
| Variable independiente: age_group    | Cualitativa politómica | Ordinal           | 0: 0-4        |
|                                      |                        |                   |               |
|                                      |                        |                   | 1: 5-9        |
|                                      |                        |                   |               |
|                                      |                        |                   | 2: 10-14      |
|                                      |                        |                   |               |
|                                      |                        |                   | 3: 15-19      |
|                                      |                        |                   |               |
|                                      |                        |                   | 4: 20-24      |
|                                      |                        |                   |               |
|                                      |                        |                   | 5: 25-29      |
|                                      |                        |                   |               |
|                                      |                        |                   | 6: 30-34      |
|                                      |                        |                   |               |
|                                      |                        |                   | 7: 35-39      |
|                                      |                        |                   |               |
|                                      |                        |                   | 8: 40-44      |
|                                      |                        |                   |               |
|                                      |                        |                   | 9: 45-49      |
|                                      |                        |                   |               |
|                                      |                        |                   | 10: 50-54     |
|                                      |                        |                   |               |
|                                      |                        |                   | 11: 55-59     |
|                                      |                        |                   |               |
|                                      |                        |                   | 12: 60-64     |
|                                      |                        |                   |               |
|                                      |                        |                   | 13: 65-69     |
|                                      |                        |                   |               |
|                                      |                        |                   | 14: 70-74     |
|                                      |                        |                   |               |
|                                      |                        |                   | 15: 75-79     |
|                                      |                        |                   |               |
|                                      |                        |                   | 16: 80-84     |
|                                      |                        |                   |               |
|                                      |                        |                   | 17: 85+       |
+--------------------------------------+------------------------+-------------------+---------------+
| Variable independiente: period_group | Cualitativa politómica | Ordinal           | 0: 1983-1987  |
|                                      |                        |                   |               |
|                                      |                        |                   | 1: 1988-1992  |
|                                      |                        |                   |               |
|                                      |                        |                   | 2: 1993-1997  |
|                                      |                        |                   |               |
|                                      |                        |                   | 3: 1998-2002  |
|                                      |                        |                   |               |
|                                      |                        |                   | 4: 2003-2007  |
|                                      |                        |                   |               |
|                                      |                        |                   | 5: 2008-2012  |
|                                      |                        |                   |               |
|                                      |                        |                   | 6: 2013-2017  |
|                                      |                        |                   |               |
|                                      |                        |                   | 7: 2018-2022  |
+--------------------------------------+------------------------+-------------------+---------------+
| Variable independiente: cohort_group | Cualitativa politómica | Ordinal           | 0: 1898-1902  |
|                                      |                        |                   |               |
|                                      |                        |                   | 1: 1903-1907  |
|                                      |                        |                   |               |
|                                      |                        |                   | 2: 1908-1912  |
|                                      |                        |                   |               |
|                                      |                        |                   | 3: 1913-1917  |
|                                      |                        |                   |               |
|                                      |                        |                   | 4: 1918-1922  |
|                                      |                        |                   |               |
|                                      |                        |                   | 5: 1923-1927  |
|                                      |                        |                   |               |
|                                      |                        |                   | 6: 1928-1932  |
|                                      |                        |                   |               |
|                                      |                        |                   | 7: 1933-1937  |
|                                      |                        |                   |               |
|                                      |                        |                   | 8: 1938-1942  |
|                                      |                        |                   |               |
|                                      |                        |                   | 9: 1943-1947  |
|                                      |                        |                   |               |
|                                      |                        |                   | 10: 1948-1952 |
|                                      |                        |                   |               |
|                                      |                        |                   | 11: 1953-1957 |
|                                      |                        |                   |               |
|                                      |                        |                   | 12: 1958-1962 |
|                                      |                        |                   |               |
|                                      |                        |                   | 13: 1963-1967 |
|                                      |                        |                   |               |
|                                      |                        |                   | 14: 1968-1972 |
|                                      |                        |                   |               |
|                                      |                        |                   | 15: 1973-1977 |
|                                      |                        |                   |               |
|                                      |                        |                   | 16: 1978-1982 |
|                                      |                        |                   |               |
|                                      |                        |                   | 17: 1983-1987 |
|                                      |                        |                   |               |
|                                      |                        |                   | 18: 1988-1992 |
|                                      |                        |                   |               |
|                                      |                        |                   | 19: 1993-1997 |
|                                      |                        |                   |               |
|                                      |                        |                   | 20: 1998-2002 |
|                                      |                        |                   |               |
|                                      |                        |                   | 21: 2003-2007 |
|                                      |                        |                   |               |
|                                      |                        |                   | 22: 2008-2012 |
|                                      |                        |                   |               |
|                                      |                        |                   | 23: 2013-2017 |
|                                      |                        |                   |               |
|                                      |                        |                   | 24: 2018-2022 |
+--------------------------------------+------------------------+-------------------+---------------+

## Aspectos teóricos del modelo de edad, período y cohorte

Los efectos temporales de la edad, el período y la cohorte de nacimiento (APC) (variables independientes) sobre la mortalidad por diabetes (variable dependiente), se representa en esta investigación bajo el modelo de clasificación múltiple o modelo contable, por medio de una tabla Lexis. En esta tabla, las filas corresponden a diferentes grupos de edad, las columnas a los diferentes grupos de períodos y las diagonales a las diferentes cohortes de nacimiento.

**Definición de variables:**

***Edad:*** Corresponde a la edad en años cumplidos en el momento de la ocurrencia o medición del desenlace de interés, en este caso, corresponde a la edad regístrada al momento del fallecimiento atribuido a diabetes mellitus.

-   ***Efectos de la edad:*** Corresponde a los cambios o variaciones del desenlace vinculados a procesos biológicos (cambios fisiológicos) y/o sociales (experiencias) realcionados con el evejecimiento de los individuos y las poblaciones.

***Período:*** Corresponde al año calendario registrado en el momento de la ocurrencia o medición del desenlace de interés, en este caso, corresponde al año calendario en el cual se presenta el fallecimiento por diabetes mellitus.

-   **Efectos del período:** Corresponde a los cambios o variaciones del desenlace vinculados a procesos externos que afectan por igual a todos los grupos de edad y grupos de cohortes de nacimiento en un momento calendario particular.

**Cohorte:** Corresponde al año de nacimiento de la persona que presentó el desenlace, en este caso, corresponde al año de nacimiento del individuo que falleció por diabetes mellitus en un momento del tiempo.

-   ***Efectos de la cohorte:*** Corresponde a los cambios o variaciones del desenlace como resultado de las experiencias o exposiciones únicas de un grupo de sujetos a medida que avanzan en el tiempo.

***Variable dependiente:***

-   Conteo de fallecimientos por diabetes mellitus registrados durante los años 1983 a 2022 en Colombia, según grupos de edad en quinquenios, períodos calendario en quinquenios y cohortes de nacimiento en quinquenios.

-   Tasa de mortalidad de diabetes mellitus por cada 100.000 personas durante los años 1983 a 2022 en Colombia, según grupos de edad en quinquenios, períodos calendario en quinquenios y cohortes de nacimiento en quinquenios.

    Para la construcción de la tasa, según edad, período y cohorte, se tuvo en cuenta el conteo de fallecimientos y la población a mitad de período de las proyecciones y retroproyecciones del Departamento Administrativo Nacional de Estadística (DANE).

**Ejemplo de tabla Lexis:**

![](Tabla_Lexis.png)

**Las dimensiones de la tabla Lexis son:**

-   **Grupos de edad (filas (i)):** 18 grupos de edad en quinquenios desde los 0 a 4 años hasta los 85 años y más.

-   **Grupos de período (columnas (j)):** 8 grupos de período en quinquenios desde 1983 a 1987 hasta 2018 a 2022.

-   **Grupos de cohorte de nacimiento (diagonales (k)):** 25 grupos de cohorte en quinquenios desde 1898 a 1902 hasta 2018 a 2022.

-   **La categoría de la cohorte de cada celda es igual a:** Categoría de grupo de período - Categoría de grupo de edad + Total grupos de edad

-   **El total de cohortes es igual a:** Total grupos de edad + Total grupos de período - 1

**Tabla Lexis con los datos de la presente investigación:**

A continuación, se presenta la tabla Lexis de la presente investigación. En cada celda se registra el conteo de fallecimientos por diabetes (numero absoluto) y la tasa de mortalidad de diabetes por cada 100.000 personas para la población a nivel general. Las tablas Lexis según sexo se puden encontrar en el material suplementario del manuscrito.

![](Tabla_Lexis_2.png)

**Análisis de las bases de datos:**

Para analizar el efecto de la edad, el período y la cohorte de nacimiento sobre la tasa de mortalidad por diabetes mellitus en Colombia durante los años 1983 a 2022, se realizará diferentes análisis secuenciales. Estos análisis son los propuestos por la **Universidad de Columbia** (basado en los autores Yang y Land) y por el **Profesor Wenjiang Fu** para el analísis de datos en un modelo de edad, período y cohorte.

-   *Analísis descriptivo de los datos:* Por medio de tablas y gráficos (unidimensionales, bidimensionales y tridimensionales) para realizar una primera aproximación cualitativa de los patrones de variaciones basados en el tiempo.

-   *Modelos de regresión simple:* Por medio de la inclusión de la edad, el período o la cohorte como variables independientes únicas en los modelos de regresión. De cada modelo se compara las medidas de bondad de ajuste.

-   *Modelos de regresión múltiple:* Por medio de la inclusión de la combinación de dos o tres variables independientes (edad, período y/o cohorte). De cada modelo se compara las medidas de bondad de ajuste.

-   *Decisión:* Si los analísis indican que las tres variables independientes no son candidatas para ingresar a los modelos de regresión, se debe de seleccionar un modelo reducido (dos o una sola variable independiente, según corresponda). En este caso, no existe el problema de no identificación del modelo.

    Sin embargo, si los analísis sugieren que las tres variables son candidatas para ingresar al modelo completo de regresión, se debe de especificar algún método estadístico para solucionar el problema de no identificación.

    **Nota:** El problema de no identificación del modelo se presenta debido a la colinealidad perfecta entre la edad, el período y la cohorte de nacimiento, es decir, a partir de la información de dos variables se conoce la tercera variable (Cohorte = edad - período). Esto produce una matriz de diseño singular, en la cual, es imposible estimar el efecto independiente de la edad, el período y la cohorte sobre el desenlace.

    Para solucionar el problema de no identificación del modelo existen múltiples estrategias desde la estadística y la epidemiología. Estas estrategias se dividen en **identificación de efectos sin causas medidas** y en **identificación de efectos con causas medidas**.

![](Estrategias%20problema%20de%20no%20identificación.png)

## Metodología y plan de análisis

1.  **Pregunta de investigación**

¿Cuáles son los efectos de la edad, el período y la cohorte de nacimiento sobre la tendencia en la tasa de mortalidad por diabetes mellitus en Colombia durante el período de tiempo comprendido entre 1983-2022?

2.  **Objetivo general**

Estimar las contribuciones de los efectos de la edad, el período y la cohorte de nacimiento sobre la tendencia en la tasa de mortalidad por diabetes mellitus en Colombia durante el período de tiempo comprendido entre 1983-2022.

3.  **Objetivos específicos**

-   Describir el comportamiento de la tasa de mortalidad por diabetes mellitus en Colombia según los grupos de edad, grupos de período y grupos de cohorte de nacimiento, a nivel de población general y según sexo, entre los años 1983 y 2022.

-   Evaluar cualitativamente los efectos de la edad, el período y la cohorte de nacimiento sobre los cambios en la tasa de mortalidad por diabetes mellitus en Colombia, a nivel de población general y según sexo, entre los años 1983 y 2022.

-   Determinar el efecto independiente de la edad, el período y la cohorte de nacimiento sobre los cambios en la tasa de mortalidad de diabetes mellitus en Colombia, a nivel de población general y según sexo, entre los años 1983 y 2022.

4.  **Tipo de estudio**

Estudio observacional analítico, con datos trasversales agrupados, de diferentes registros de mortalidad por DM para Colombia entre los años 1983 y 2022.

**Nota:** Los datos recolectados en varios estudios transversales de mortalidad permite obtener variaciones en las edades, en los períodos y en las cohortes de nacimiento (Como se demostró previamente en el diseño de las tablas Lexis). Sin embargo, esto implica más adelante en los modelos de regresión intentar solucionar el problema de no identificación del modelo.

![](Estudios%20epidemiológicos%20en%20APC.png)

Adaptado de Andrew Bell (2020).

5.  **Plan de análisis estadístico**

**Objetivo especifíco 1:** Describir el comportamiento de la tasa de mortalidad por diabetes mellitus en Colombia según los grupos de edad, grupos de período y grupos de cohorte de nacimiento, a nivel de población general y según sexo, entre los años 1983 y 2022.

**1.** *Análisis descripivo univariado:*

-   Incluye medidas de resumen, gráfico de densidad y gráfico boxplot de la variable dependiente (conteo de fallecimientos por diabetes mellitus y tasa de mortalidad de diabetes mellitus por cada 100.000 personas), para analizar la distribución de los datos entre los años 1983 y 2022.

**2.** *Análisis descriptivo bivariado:*

-   Tablas que incluyen las frecuencias absolutas y porcentuales de los fallecimientos atribuidos a DM en cada grupo de edad, período y cohorte, entre los años de 1983 y 2022.

-   Tablas que incluyen las tasas crudas específicas de mortalidad de DM por cada 100.000 personas en cada grupo de edad, período y cohorte, entre los años de 1983 y 2022.

-   Gráficos unidimensionales de boxplot de la tasa de mortalidad de diabetes por cada 100.000 personas en escala logarítmica según la edad, el período y la cohorte de nacimiento.

**Objetivo especifíco 2:** Evaluar cualitativamente los efectos de la edad, el período y la cohorte de nacimiento sobre los cambios en la tasa de mortalidad por diabetes mellitus en Colombia, a nivel de población general y según sexo, entre los años 1983 y 2022.

**3.** *Análisis descriptivo con gráficos bidimensionales:* Gráficos bidimensionales de líneas de la tasa de mortalidad por DM en escala logarítmica para evaluar cualitativamente el efecto de la edad según los periodos y las cohortes; el efecto del período según las edades y las cohortes; y el efecto de la cohorte según los grupos de edad y períodos.

**4.** *Análisis descriptivo con mapa de calor:* Gráfico a partir de la tabla de Lexis en donde las filas corresponden a los grupos de edad, las columnas a los grupos de períodos y las diagonales a los grupos de cohortes de nacimiento. Se visualiza en una convención de colores la escala logarítmica de la tasa de mortalidad de DM por cada 100.000 personas.

**5.** *Análisis descriptivo con gráfico tridimensional:* Gráfico en donde el eje X corresponde a los grupos de edad, el eje Y a los grupos de período y el eje Z a los grupos de cohorte de nacimiento, en función de la tasa de mortalidad de DM por cada 100.000 personas en escala logarítmica.

**Objetivo especifíco 3:** Determinar el efecto independiente de la edad, el período y la cohorte de nacimiento sobre los cambios en la tasa de mortalidad de diabetes mellitus en Colombia, a nivel de población general y según sexo, entre los años 1983 y 2022.

**6.** *Modelos de regresión de quasi-poisson simples:* En el cual se incluye el conteo esperado de fallecimientos por diabetes mellitus como variable dependiente, el conteo de población a mitad de período como termino de compensación (offset) y como variables independientes la edad, el período o la cohorte.

De cada modelo simple se reporta el coeficiente de regresión y el intervalo de confianza del 95%, así mismo, el exponencial del coeficiente de regresión y de los intervalos de confianza, que corresponde a la razón de la tasa de mortalidad (RTM) de cada edad, período y cohorte en comparación con la tasa de mortalidad promedio global. Adicionalmente, se reporta los deviance y el parámetro de dispersión como medida de bondad de ajuste.

**Modelo teoríco de quasi-poisson simple para la edad (en función de la tabla Lexis):**

![](Ecuacion%20simple%20edad.png){width="300"}

En donde,

![](Explicacion%20ecuacion%20simple%20edad.png)

**Modelo teoríco de quasi-poisson simple para el período (en función de la tabla Lexis):**

![](Ecuacion%20simple%20periodo.png){width="300"}

En donde,

![](Explicacion%20ecuacion%20simple%20periodo.png)

**Modelo teoríco de quasi-poisson simple para la cohorte (en función de la tabla Lexis):**

![](Ecuacion%20simple%20cohorte.png){width="300"}

En donde,

![](Explicacion%20ecuacion%20simple%20cohorte.png)

**Recordar parámetro de dispersión:**

En el modelo de Poisson se asume el cumplimiento del supuesto de equidispersión, es decir, la varianza de la variable de respuesta es igual a la media, por su parte, el modelo de quasi-poisson permite que la varianza sea una función de la media multiplicada por un parametro de dispersión, lo que permite manejar el no cumplimiento del supuesto de equidispersion.

El parámetro de dispersión entonces describe como la varianza de los datos difiere de la varianza esperada, bajo el supuesto de una distribución de Poisson, en la cual la varianza es igual a la media.

**7.** *Modelos de regresión de quasi-poisson multiples:* En el cual se incluye dos variables independientes, las cuales son la edad-periodo, y la edad-cohorte.

De cada modelo múltiple se reporta el coeficiente de regresión y el intervalo de confianza del 95%, así mismo, el exponencial del coeficiente de regresión y de los intervalos de confianza, que corresponde a la razón de la tasa de mortalidad (RTM) de cada edad, período y cohorte en comparación con la tasa de mortalidad promedio global. Adicionalmente, se reporta los deviance y el parámetro de dispersión como medida de bondad de ajuste.

**Modelo teoríco de quasi-poisson múltiple para la edad y el período (en función de la tabla Lexis):**

![](Ecuacion%20edad%20periodo.png){width="300"}

En donde,

![](Explicacion%20ecuacion%20edad%20periodo.png)

**Modelo teoríco de quasi-poisson múltiple para la edad y el cohorte (en función de la tabla Lexis):**

![](Ecuacion%20edad%20cohorte.png){width="300"}

En donde,

![](Explicacion%20ecuacion%20edad%20cohorte.png)

**8.** *Modelo de regresión de quasi-poisson multiple completo:* En el cual se incluye a las tres variables independientes de edad, periodo y cohorte.

Del modelo múltiple completo se reporta el coeficiente de regresión y el intervalo de confianza del 95%, así mismo, el exponencial del coeficiente de regresión y de los intervalos de confianza, que corresponde a la razón de la tasa de mortalidad (RTM) de cada edad, período y cohorte en comparación con la tasa de mortalidad promedio global. Adicionalmente, se reporta los deviance y el parámetro de dispersión como medida de bondad de ajuste.

De igual forma, se realiza el gráfico del efecto independiente de la edad, del período y de la cohorte de nacimiento sobre la tasa de mortalidad de diabetes por cada 100.000 personas en escala logarítimica.

Para poder establecer el efecto independiente de las variables edad, período y cohorte se aplica el método del estimador intrínseco en el modelo de quasi-poisson, con la finalidad de solucionar desde un punto de vista estadístico el problema de no identificabilidad.

El método del estimador intrinseco hace parte de las estrategias de identificación de efectos sin causas medidas aplicando restricciones mecánicas por medio de estimadores de Moore-Pensore. En términos generales, el modelo proporciona resultados de estimación imparciales y relativamente eficientes al aplicar el análisis de componentes principales a la descomposición de la matriz de datos y generar una función estimable que permita el cálculo del efecto independiente de cada predictor.

En el texto "A practical guide to age-period-cohort analysis. The identification problem and beyond" del autor Wenjiang Fu se puede encontrar una descripción más profunda del metodo del estimador intrinseco para análisis de datos APC.

**Modelo teoríco de quasi-poisson múltiple completo (en función de la tabla Lexis):**

![](Ecuacion%20APC.png){width="300" height="24"}

En donde,

![](Explicacion%20APC.png)

**Nota:** En las ecuaciones simples y múltiples de los modelos teóricos la variable dependiente también se puede comprender como el logarítmo natural de la tasa de mortalidad esperada del i-ésimo grupo de edad en el j-ésimo grupo de período (k-ésimo grupo de cohorte). Esto debido a que los modelos utilizan el número esperado de fallecimientos como variable dependiente y la población a riesgo como término de compensación.

**Por tal motivo, la ecuación del modelo (en función de la tabla Lexis) también se puede expresar como:**

![](APC%20modelo%20artículo.png){width="300" height="58"}

En donde,

![](Explicacion%20APC%20modelo%20artículo.png){width="3163"}

**Solución del problema de no identificación del modelo:**

El problema de no identificación en un modelo de edad, período y cohorte, como se discutió previamente, surge de la multicolinealidad perfecta entre edad, período y cohorte, esto ocurre cuando una o más variables predictoras pueden expresarse como una combinación lineal extacta de otras variables predictoras. Esto hace que sea imposible estimar independientemente los efectos de la edad, el período y la cohorte sobre la tasa de mortalidad de DM.

Por tal motivo, para poder calcular el efecto estadístico independiente de la edad, el período y la cohorte sobre la tasa de mortalidad de diabetes se aplica el **método del estimador intrinseco con intención de colapso propuesto por el profesor Wenjiang Fu**.

**Explicación de la sintaxis de los modelos de quasi-poisson con el paquete APCG1 del autor Wenjiang Fu:**

La función apcglmfit de paquete APCG1 permite la aplicación de modelos lineales generalizados para el análisis de datos edad, período y cohorte. Los argumentos de la función incluye:

-   **r:** matriz de tasa o valor de APC con filas como grupos de edad y columnas como grupos de períodos. En este caso corresponde a la tasa de mortalidad de diabetes por cada 100.000 personas en cada grupo de edad y período.

-   **header:** valor lógico, si es verdadero la matriz contiene las etiqueteas de de fila y columna como encabezado.

-   **n.risk:** matriz de exposición de la población que tiene la misma dimensión que la matriz r. Su encabezado no es obligatorio.

-   **apcmodel:** modelos para ajustarse a los datos APC: "A", "P", "C" para modelos de factor único; "AP", "AC" para modelos de dos factores o "APC" para el modelo APC completo.

-   **fam:** familia de modelos para ajustar: "loglin" para el modelo loglineal de Poisson, o "qlik" para el modelo quasi-Poisson (loglineal).

-   **Plot:** valor lógico, verdadero para gráficos del efecto.

-   **pylim:** rango de valores en el gráfico de estimación.

-   **Scale:** escala de los datos r, el valor predeterminado es 1e-5 para la tasa.

-   **apc:** valor para especificar el factor en una restricción: 1 para efectos de edad; 2 para efectos de período; 3 para efectos de cohorte. **0 indica el estimador intrínseco.**

-   **lindex, ivalue:** valores para especificar efectos y coeficientes en una restricción: lindex\*lvalue = 0.

-   **amin, pmin, cmin:** valores iniciales de edad, período y cohorte para las etiquetas. No es necesario para datos con encabezado.

-   **n.interval:** número de unidades en cada grupo de edad o período en la etiqueta. No es necesario para datos con encabezado.

-   **pcex:** valor para especificar la fuente de los caracteres del gráfico.

**Entre los resultados de salida del modelo se encuentra:**

-   **model:** especificación del modelo y familia.

-   **deviance:** deviance del modelo y grados de libertad.

-   **pearson.chisq:** estadístico de chi-cuadrado de pearson.

-   **p.val:** Valor p de la bondad de ajuste del modelo por la desviación siguiendo la distribución chi-cuadrado.

-   **dispersion:** parámetro de dispersión, si se especifica cuasi verosimilitud (para modelo quasi-Poisson).

-   **parameter:** estimaciones de parámetros para los efectos de intersección, edad, período y cohorte, errores estándar, valores Z (o valores t, si se especifica la cuasi verosimilitud) y valores p.

**Ejemplo sintaxis:**

```{r}
#apcglmfit(r=x$rate,n.risk = x$pop, header=TRUE, Plot=TRUE, apcmodel = "APC",apc=0, Scale = 1e-5,fam="qlik")
```

**Ejemplo especificación del modelo:**

```{r}
#$model
#glm(formula = rr ~ x - 1 + offset(log(n.risk)), family = quasipoisson(link = log))
```

-   **rr:** variable dependiente que corresponde a los casos esperados del evento. Se espera que los datos de entrada para la función apcglmfit sean las tasas y que la población en riesgo se utilice como un término de compensación (offset). El comando toma la matriz r (tasas) como entrada y calcula los casos esperados de fallecimiento ajustando la tasa de mortalidad por la población en riesgo, como se indica a continuación:

```{r}
#rr = c(t(round(r*n.risk/100000, 0)))
#  if (fam == "loglin") {
#    fit = glm(rr ~ x - 1 + offset(log(c(t(n.risk)))), family = poisson(link = log))
#  } else if (fam == "qlik") {
#    fit = glm(rr ~ x - 1 + offset(log(c(t(n.risk)))), family = quasipoisson(link = log))
#  } else
#  {
#    stop("Wrong family of model!")
#  }
```

-   Por tal motivo, las tasas de mortalidad (r) se ajustan multiplicándolas por la población expuesta a riesgo (n.risk) y dividiendo por 100.000, y así, obtener el número de fallecimientos esperados. Posteriormente, los casos esperados del evento se utilizan como variable de respuesta (rr) en los modelos de regresión lineal generalizados. Esto permite obtener ventajas en la estimación del modelo, como un ajuste adecuado de los casos del evento en función de los cambios demográficos, y poder establecer comparaciones mucho más pertinentes.

-   El valor predeterminado de Scale es 1e-5 lo cual indica que las tasas de mortalidad en la matriz r están escaladas por cada 100.000 personas.

**Nota:** Los anteriores análisis se realizan y presentan para la mortalidad por DM sin especificar el sexo, y a su vez, desagregado por sexo masculino y sexo femenino.

# Análisis para diabetes mellitus (población a nivel general)

## 1. Análisis descriptivo univariado

**Variable dependiente:**

*Conteo de fallecimientos por diabetes mellitus*

-   Medidas de resumen:

```{r}
descr(bd_long_dm$deaths)
```

-   Gráfico de densidad:

```{r}
ggplot(bd_long_dm, 
       aes(x = deaths, 
           fill = "Density")) +
  geom_density(alpha = 0.7, 
               color = "darkblue", fill = "darkblue") +
  labs(x = "Conteo fallecimientos", y = "Densidad") +
  ggtitle("Gráfico de densidad del conteo de fallecimientos por diabetes mellitus")
```

-   Gráfico boxplot:

```{r,warning=FALSE}
ggplot(bd_long_dm, 
       aes(x = deaths)) +
  geom_boxplot(color = "darkblue", alpha = 0.5) +
  ggtitle("Boxplot del conteo de fallecimientos por diabetes mellitus")
```

**Interpretación:** Según el analísis descriptivo univariado, el valor mínimo y máximo registrado en el conteo de fallecimientos por diabetes entre los años 1983 a 2022, fue de 9 casos y de 9.530 casos respectivamente. La mediana del conteo de fallecimientos fue de 593 casos con un rango intercuartílico de 2.422,50 (Q3 = 2.562,50 - Q1 = 122,50), lo que refleja que al menos el 50% del conteo de casos de fallecimientos por diabetes se ubican o se agrupan dentro de este intervalo, presentando el conjunto de datos una amplia dispersión.

Adicionalmente, según el skewness (medida de la asimetría en relación con la media) indica que la distribución de los datos presenta una asimetría positiva (sesgo positivo), con una cola de datos extensa al lado derecho de la curva y, posiblemente, presencia de valores extremos que influyen en el resultado de la media, ocasionando que la media sea mayor que la mediana.

Estos valores extremos son confirmados en el gráfico de caja y bigotes, y la forma de la distribución de los datos con un sesgo positivo se observa adecuadamente en el gráfico de densidad.

*Tasa de mortalidad de diabetes mellitus por cada 100.000 personas*

-   Medidas de resumen:

```{r}
descr(bd_long_dm$mortality_rate)
```

-   Gráfico de densidad:

```{r,warning=FALSE}
ggplot(bd_long_dm, 
       aes(x = mortality_rate, 
           fill = "Density")) +
  geom_density(alpha = 0.7, color = "darkgreen", fill = "darkgreen") +
  labs(x = "Tasa cruda de mortalidad", y = "Densidad") +
  ggtitle("Gráfico de densidad tasa cruda de mortalidad por diabetes mellitus")
```

-   Gráfico boxplot:

```{r,warning=FALSE}
ggplot(bd_long_dm, 
       aes(x = mortality_rate)) +
  geom_boxplot(color = "darkgreen", alpha = 0.5) +
  ggtitle("Boxplot tasa cruda de mortalidad por diabetes mellitus")
```

**Interpretación:** Según el analísis descriptivo univariado, el valor minimo y máximo registrado en la tasa cruda de mortalidad de diabetes entre los años 1983 y 2022, fue de 0,04 casos y de 436,12 casos por cada 100.000 personas respectivamente. La mediana de la tasa de mortalidad fue de 5,88 casos por cada 100.000 personas con un rango intercuartílico de 73,82 (Q3 = 75,30 - Q1 = 0,72), lo que refleja que al menos el 50% de las tasas de mortalidad por diabetes se ubican o se agrupan dentro de este intervalo, presentando el conjunto de datos una amplia dispersión.

Adicionalmente, según el skewness (medida de la asimetría en relación con la media) indica que la distribución de los datos presenta una asimetría positiva (sesgo positivo), con una cola de datos extensa al lado derecho de la curva, y posiblemente presencia de valores extremos que influyen en el resultado de la media, ocasionando que la media sea mayor que la mediana.

Estos valores extremos son confirmados en el gráfico de caja y bigotes, y la forma de la distribución de los datos con un sesgo positivo se observa adecuadamente en el gráfico de densidad. Este sesgo positivo de los datos de la tasa de mortalidad por diabetes y presencia de valores atípicos es mucho más significativo en comparación con los datos anteriores de conteo.

## 2. Análisis descriptivo bivariado

**Variable dependiente en función de los grupos de edad, grupos de período y grupos de cohorte de nacimiento:**

-   Conteo de fallecimientos por diabetes mellitus según grupos de edad

```{r}
bd_long_dm %>%
  group_by(age_group) %>%
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Frecuencia_Porcentual = round(sum(deaths) / sum(bd_long_dm$deaths) * 100, 2)
  ) %>%
  bind_rows(
    summarise(., 
              age_group = "Total", 
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Frecuencia_Porcentual = sum(Frecuencia_Porcentual))
  ) %>%
  knitr::kable()
```

-   Conteo de fallecimientos por diabetes mellitus según grupos de período

```{r}
bd_long_dm %>%
  group_by(period_group) %>%
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Frecuencia_Porcentual = round(sum(deaths) / sum(bd_long_dm$deaths) * 100, 2)
  ) %>%
  bind_rows(
    summarise(., 
              period_group = "Total", 
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Frecuencia_Porcentual = sum(Frecuencia_Porcentual))
  ) %>%
  knitr::kable()
```

-   Conteo de fallecimientos por diabetes mellitus según grupos de cohorte de nacimiento

```{r}
bd_long_dm %>%
  group_by(cohort_group) %>%
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Frecuencia_Porcentual = round(sum(deaths) / sum(bd_long_dm$deaths) * 100, 2)
  ) %>%
  bind_rows(
    summarise(., 
              cohort_group = "Total", 
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Frecuencia_Porcentual = sum(Frecuencia_Porcentual))
  ) %>%
  knitr::kable()
```

-   Tasa cruda de mortalidad por diabetes mellitus según grupos de edad

```{r}
bd_long_dm %>%
  group_by(age_group) %>%
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Poblacion = sum(population),
    Tasa_especifica = round((sum(deaths) / sum(population)) * 100000, 2)
  ) %>%
  bind_rows(
    summarise(., 
              age_group = "Total", 
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Poblacion = sum(Poblacion),
              Tasa_especifica = round((sum(Conteo_fallecimientos) / sum(Poblacion)) * 100000, 2))
  ) %>%
  knitr::kable()
```

-   Tasa cruda de mortalidad por diabetes mellitus según grupos de período

```{r}
bd_long_dm %>%
  group_by(period_group) %>%
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Poblacion = sum(population),
    Tasa_especifica = round((sum(deaths) / sum(population)) * 100000, 2)
  ) %>%
  bind_rows(
    summarise(., 
              period_group = "Total", 
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Poblacion = sum(Poblacion),
              Tasa_especifica = round((sum(Conteo_fallecimientos) / sum(Poblacion)) * 100000, 2))
  ) %>%
  knitr::kable()
```

-   Tasa cruda de mortalidad por diabetes mellitus según grupos de cohorte

```{r}
bd_long_dm %>%
  group_by(cohort_group) %>%
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Poblacion = sum(population),
    Tasa_especifica = round((sum(deaths) / sum(population)) * 100000, 2)
  ) %>%
  bind_rows(
    summarise(., 
              cohort_group = "Total", 
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Poblacion = sum(Poblacion),
              Tasa_especifica = round((sum(Conteo_fallecimientos) / sum(Poblacion)) * 100000, 2))
  ) %>%
  knitr::kable()
```

**Interpretación:** Según la información obtenida en las tablas de frecuencia, se observa que la mayor frecuencia porcentual de fallecimietos por diabetes ocurrieron en la edad de mayores o iguales de 85 años con un 15,05%, en el período de tiempo entre 2018 a 2022 con un 19,25% y en la cohorte de nacimiento de 1933 a 1937 con un 15,05%. Por su parte, las menores frecuencias porcentuales de fallecimientos por diabetes ocurrieron en la edad de 5 a 9 años con un 0,06%, en el período de tiempo de 1983 a 1987 con un 5,27% y en las cohortes de nacimiento de 2018 a 2022 con un 0,05%.

Adicionalmente, la mayor tasa cruda de mortalidad de diabetes se presentó en la edad de mayores o iguales a 85 años con una tasa de 328,57 por cada 100.000 personas, en el período de tiempo de 2018 a 2022 con una tasa de 17,96 por cada 100.000 personas y en las cohortes de nacimiento de 1913 a 1917 con una tasa de 202,07 por cada 100.000 personas. Por su parte, la menor tasa cruda de mortalidad de diabetes se presentó en la edad de 5 a 9 años con una tasa de 0,08 por cada 100.000 personas, en el período de tiempo de 1983 a 1987 con una tasa de 8,11 por cada 100.000 personas y en las cohortes de nacimiento de 2013 a 2017 con una tasa de 0,07 por cada 100.000 personas.

**Variable dependiente en función de la edad, el período y la cohorte (Gráficos unidimensionales):**

-   Gráfico boxplot en escala logaritmica para la tasa de mortalidad de diabetes según edad

```{r,message=FALSE,warning=FALSE}
#Colores para el gráfico
coloresgg1 <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7")

# Especificar orden de los grupos de edad
bd_long_dm$age_group <- factor(bd_long_dm$age_group, 
                               levels = c("0-4", "5-9", "10-14", 
                                          "15-19", "20-24", "25-29", 
                                          "30-34", "35-39", "40-44", 
                                          "45-49", "50-54", "55-59", 
                                          "60-64", "65-69", "70-74", 
                                          "75-79", "80-84", "85+"))

# Grafico boxplot
ggplot(bd_long_dm, aes(x = age_group, 
                       y = log10(mortality_rate), 
                       fill = age_group)) + 
  geom_boxplot() + 
  scale_fill_manual(values = coloresgg1) + 
  labs(x = "Grupos de edad", 
       y = "Tasa de Mortalidad de DM*100.000 (log10)", 
       fill = "Grupos de edad") +
  ggtitle("Tasa de mortalidad por DM según grupos de edad (A)") + 
  theme_minimal() + 
  theme(axis.text.x = element_text(color = "black", angle = 45, size = 18), 
        axis.text.y = element_text(color = "black", size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18))
```

-   Gráfico boxplot en escala logaritmica para la tasa de mortalidad de diabetes según períodos

```{r,message=FALSE,warning=FALSE}
#Colores para el gráfico
coloresgg2 <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f")

# Especificar orden de los grupos de período
bd_long_dm$period_group <- factor(bd_long_dm$period_group, 
                                  levels = c("1983-1987", "1988-1992", "1993-1997", 
                                             "1998-2002", "2003-2007", "2008-2012", 
                                             "2013-2017", "2018-2022"))

# Grafico boxplot
ggplot(bd_long_dm, aes(x = period_group, 
                            y = log10(mortality_rate), 
                            fill = period_group)) +
  geom_boxplot() +
  scale_fill_manual(values = coloresgg2) +
  labs(x = "Grupos de período", 
       y = "Tasa de Mortalidad de DM*100.000 (log10)", 
       fill = "Grupos de Período") +
  ggtitle("Tasa de mortalidad por DM según grupos de período (B)") +
  theme_minimal() + 
  theme(axis.text.x = element_text(color = "black", angle = 45, size = 18),
        axis.text.y = element_text(color = "black", size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18))
```

-   Gráfico boxplot en escala logaritmica para la tasa de mortalidad de diabetes según cohortes

```{r}
# Colores para el gráfico
coloresgg3 <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f",
                "#bcbd22",
                "#17becf",
                "#aec7e8",
                "#ffbb78",
                "#98df8a",
                "#ff9896",
                "#c5b0d5",
                "#c49c94",
                "#f7b6d2",
                "#c7c7c7",
                "#dbdb8d",
                "#9edae5",
                "#ad494a",
                "#8c6d31",
                "#e7ba52",
                "#9467bd",
                "#d6616b")

# Especificar orden de los grupos de cohortes
bd_long_dm$cohort_group <- factor(bd_long_dm$cohort_group, 
                                  levels = c("1898-1902", "1903-1907", "1908-1912", 
                                             "1913-1917", "1918-1922",
                                             "1923-1927", "1928-1932", "1933-1937",
                                             "1938-1942", "1943-1947",
                                             "1948-1952", "1953-1957", "1958-1962", 
                                             "1963-1967", "1968-1972",
                                             "1973-1977", "1978-1982", "1983-1987", 
                                             "1988-1992", "1993-1997",
                                             "1998-2002", "2003-2007", "2008-2012", 
                                             "2013-2017", "2018-2022"))

# Grafico boxplot
ggplot(bd_long_dm, aes(x = cohort_group, 
                            y = log10(mortality_rate), 
                            fill = cohort_group)) +
  geom_boxplot() +
  scale_fill_manual(values = coloresgg3) +
  labs(x = "Grupos de Cohortes de nacimiento", 
       y = "Tasa de Mortalidad de DM*100.000 (log10)",
       fill = "Grupos de Cohortes") +
  ggtitle("Tasa de mortalidad por DM según grupos de cohortes (C)") +
  theme_minimal() +
  theme(axis.text.x = element_text(color = "black", angle = 45, size = 13),
        axis.text.y = element_text(color = "black", size = 18),
        legend.position = "top",
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18)) 
```

**Interpretación:** Según los gráficos de boxplot se aprecia que la tasa de mortalidad cruda de diabetes por cada 100.000 habitantes incrementa a medida que incrementa los grupos de edad (a excepción del grupo de edad entre 5 a 9 años), presentando una amplia dispersión de los datos en los grupos más jóvenes y en los grupos de edad avanzada (mayor distancia entre Q3 y Q1) con presencia de valores atípicos en los grupos de 35 a 39 años, 80 a 84 años y +85 años.

Con respecto a los grupos de período aparentemente no se observa cambios sustancialmente importantes entre cada período con respecto a la tasa cruda de mortalidad de diabetes. En todos los períodos, se evidencia una importante dispersión de datos al observar una amplia distancia entre el Q3 y el Q1, y no se presenta valores atípicos en ninguno de los períodos analizados.

Finalmente, con respecto a las cohortes de nacimiento,, se observa que en las cohortes más longevas se presenta un incremento en la tasa de mortalidad por diabetes, sin embargo desde la cohorte de nacimiento de 1933 a 1937 comienza una importante disminución de la tasa cruda de mortalidad por diabetes. Adicionalmente, en las cohortes intermedias existe una mayor distancia entre Q3 y Q1 lo que permite argumentar una potencial dispersión de los datos.

## 3. Análisis descriptivo con gráficos bidimensionales

**Variable dependiente en función de la edad, el período y la cohorte:**

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de la edad estratificado por periodos

```{r}
# Colores para cada uno de los grupos de período
coloresgg4 <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf")

# Estilos de líneas para cada uno de los grupos de périodo
lineasgg4 <- c("solid", 
            "dashed", 
            "dotted", 
            "dotdash", 
            "longdash", 
            "twodash", 
            "dotdash", 
            "longdash", 
            "dashed", 
            "dotted")

# Gráfico de línea
edad_periodo <- ggplot(bd_long_dm, 
       aes(x = factor(age_group), 
           y = log10(mortality_rate), 
           group = period_group,
           color = factor(period_group),
           linetype = factor(period_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg4) +  
  scale_linetype_manual(values = lineasgg4) +  
  labs(x = "Grupos de edad", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de período", linetype = "Grupos de período") +
  theme_light(base_size = 10) +  
  ggtitle("Tasa de Mortalidad DM según edad y período (A)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))  

edad_periodo
```

**Interpretación:** En el gráfico bidimensional se puede observar que a mayor grupo de edad mayor incremento en la tasa de mortalidad de diabetes. Este incremento de la tasa de mortalidad en función de la edad, sucede de igual forma en todos los períodos de tiempo analizados, observando un entrecruzamiento de las líneas de cada período. No se evidecia un efecto del período de tiempo sobre la edad (es decir, que algún período de tiempo modificara el efecto de la edad sobre la mortalidad de diabetes).

Desde una perspectiva descriptiva, se puede argumentar que la población perteneciente a un mismo grupo de edad experimenta una tasa de mortalidad por diabetes relativamente similar en los diferentes períodos de tiempo.

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de los períodos estratificado por grupos de edad

```{r}
# Colores para cada uno de los grupos de edad
coloresgg5 <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7")

# Estilos de líneas para cada uno de los grupos de edad
lineasgg5 <- c("solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed")

# Gráfico de línea
periodo_edad <- ggplot(bd_long_dm, 
       aes(x = factor(period_group), 
           y = log10(mortality_rate), 
           group = age_group, 
           color = factor(age_group), 
           linetype = factor(age_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg5) +  
  scale_linetype_manual(values = lineasgg5) +  
  labs(x = "Grupos de período", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de edad", linetype = "Grupos de edad") +
  theme_light(base_size = 10) +  
  ggtitle("Tasa de Mortalidad DM según período y edad (B)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))  +  
  guides(color = guide_legend(ncol = 6))

periodo_edad
```

**Interpretación:** En el gráfico bidimensional se observa que la tasa de mortalidad por diabetes se comporta relativamenete constante a lo largo de cada período analizado, sin embargo, este comportamiento es modificado por el efecto de la edad sobre los períodos de tiempo, en donde a mayor edad se evidencia una mayor tasa de mortalidad por diabetes, independientemente del período de tiempo analizado, a excepción de la edad de 5 a 9 años que presenta la menor tasa de mortalidad en todos los períodos de tiempo analizados.

Desde una perspectiva descriptiva, se puede argumentar que la población perteneciente a un mismo período de tiempo experimenta una tasa de mortalidad por diabetes más alta en edades más mayores en comparación con edades menores.

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de las cohortes de nacimiento estratificado por grupos de edad

```{r}
# Colores para cada uno de los grupos de edad
coloresgg6 <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7")

# Estilos de líneas para cada uno de los grupos de edad
lineasgg6 <- c("solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed")

# Gráfico de línea
cohorte_edad <- ggplot(bd_long_dm, 
       aes(x = factor(cohort_group), 
           y = log10(mortality_rate), 
           group = age_group, 
           color = factor(age_group), 
           linetype = factor(age_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg6) +  
  scale_linetype_manual(values = lineasgg6) +  
  labs(x = "Grupos de cohortes de nacimiento", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de edad", linetype = "Grupos de edad") +
  theme_light(base_size = 10) +  
  ggtitle("Tasa de Mortalidad DM según cohorte y edad (C)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16)) +  
  guides(color = guide_legend(ncol = 7))

cohorte_edad
```

**Interpretación:** En el gráfico bidimensional se observa que las cohortes de nacimiento más longevas son las que presentan mayores tasas de mortalidad por diabetes, y las cohortes más jóvenes son aquellas que presentan menor tasa de mortalidad por diabetes. Sin embargo, a medida que incrementa el grupo de edad del fallecimiento en las diferentes cohortes de nacimiento, incrementa la tasa de mortalidad por diabetes, observando un efecto de la edad sobre las cohortes de nacimiento.

Desde una perspectiva descriptiva, se puede argumentar que la población perteneciente a una misma cohorte de nacimiento experimenta una tasa de mortalidad por diabetes más alta en edades más mayores en comparación con edades menores.

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de las cohortes de nacimiento estratificado por grupos de período

```{r}
# Colores para cada uno de los grupos de edad
coloresgg7 <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2",
                "#7f7f7f")

# Estilos de líneas para cada uno de los grupos de edad
lineasgg7 <- c("solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash",
                   "solid")

# Gráfico de línea
cohorte_periodo <- ggplot(bd_long_dm, 
       aes(x = factor(cohort_group), 
           y = log10(mortality_rate), 
           group = period_group, 
           color = factor(period_group), 
           linetype = factor(period_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg7) +  
  scale_linetype_manual(values = lineasgg7) +  
  labs(x = "Grupos de cohortes de nacimiento", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de período", linetype = "Grupos de período") +
  theme_light(base_size = 10) +  
  ggtitle("Tasa de Mortalidad DM según cohorte y período (D)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))

cohorte_periodo
```

**Interpretación:** En el gráfico bidimensional se observa que las cohortes de nacimiento más longevas presentan mayor tasa de mortalidad de diabetes, en comparación a las cohortes de nacimiento más jóvenes las cuales presentan menor tasa de mortalidad por diabetes, es decir, a medida que las cohortes de nacimiento son más recientes la tasa de mortalidad de diabetes disminuye. Sin embargo, independientemente de la cohorte de nacimiento, a mayor perído de tiempo (períodos de tiempo más recientes) mayor tasa de mortalidad de diabetes, es decir, existe un efecto del período de ocurrencia del evento sobre las cohortes de nacimiento.

Desde una perspectiva descriptiva, se puede argumentar que la población perteneciente a una misma cohorte de nacimiento experimenta una tasa de mortalidad por diabetes más alta en períodos recientes en comparación con períodos más antiguos.

**Otros gráficos adicionales:**

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de los períodos de tiempo estratificado por cohortes de nacimiento

```{r}
# Colores para cada uno de los grupos de cohorte
coloresgg8 <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7", 
                "#dbdb8d", 
                "#9edae5", 
                "#ad494a", 
                "#3182bd", 
                "#e6550d", 
                "#31a354", 
                "#756bb1")

# Estilos de líneas para cada uno de los grupos de cohorte
lineasgg8 <- c("solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid")

# Gráfico de línea
periodo_cohorte <- ggplot(bd_long_dm, 
                          aes(x = factor(period_group), 
                              y = log10(mortality_rate), 
                              group = cohort_group, 
                              color = factor(cohort_group), 
                              linetype = factor(cohort_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg8) +  
  scale_linetype_manual(values = lineasgg8) +  
  labs(x = "Grupos de períodos", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de cohorte", linetype = "Grupos de cohorte") +
  theme_light(base_size = 10) +  
  ggtitle("Tasa de Mortalidad diabetes según período y cohorte") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))  +  
  guides(color = guide_legend(ncol = 7))

periodo_cohorte
```

**Interpretación:** En el gráfico bidimensional se observa que a medida que incrementa los períodos de tiempo, es decir, períodos de tiempo más recientes, la tasa de mortalidad por diabetes experimenta incrementos. Adicionalmente, idependiente del período de tiempo analizado se presenta una mayor mortalidad por diabetes en cohortes de nacimiento más longevas en comparación a las más jóvenes, es decir, existe un efecto de la cohorte de nacimiento sobre los períodos de tiempo.

Desde una perspectiva descriptiva, se puede argumentar que la población perteneciente a un mismo periodo de tiempo experimenta una tasa de mortalidad por diabetes más alta en cohortes de nacimiento más longevas en comparación a cohortes de nacimiento más jóvenes.

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de los grupos de edad estratificado por cohortes de nacimiento

```{r}
coloresgg9 <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7", 
                "#dbdb8d", 
                "#9edae5", 
                "#ad494a", 
                "#3182bd", 
                "#e6550d", 
                "#31a354", 
                "#756bb1")

# Estilos de líneas para cada uno de los grupos de cohorte
lineasgg9 <- c("solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid")

edad_cohorte <- ggplot(bd_long_dm, 
       aes(x = factor(age_group), 
           y = log10(mortality_rate), 
           group = cohort_group, 
           color = factor(cohort_group), 
           linetype = factor(cohort_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg8) +  
  scale_linetype_manual(values = lineasgg8) +  
  labs(x = "Grupos de edad", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de cohorte", linetype = "Grupos de cohorte") +
  theme_light(base_size = 10) +  
  ggtitle("Tasa de Mortalidad DM según edad y cohorte a nivel general (A)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16)) 

edad_cohorte
```

**Interpretación:** En el gráfico bidimensional se observa que entre mayor sea el grupo de edad mayor es la tasa de mortalidad por diabetes. Este incremento de la tasa de mortalidad en función de la edad, sucede de igual forma en todas las cohortes de nacimiento analizadas, observando un entrecruzamiento de las líneas de cada cohorte. No se evidecia un efecto de la cohorte sobre la edad.

Desde una perspectiva descriptiva, se puede argumentar que, la población perteneciente a un mismo grupo de edad experimenta una tasa de mortalidad por diabetes relativamente similar en las diferentes cohortes de nacimiento.

## 4. Análisis descriptivo con mapa de calor

-   Mapa de calor de la tasa de mortalida de diabetes en escala logaritmica según la distribución de la tabla lexis (edad, períodos y cohortes)

```{r}
plot_APCheatmap(dat            = bd_long_dm,
                y_var          = "mortality_rate",
                y_var_logScale = TRUE,
                bin_heatmap    = FALSE,
                markLines_list = list(cohort = c(1898,1903,1908,1913,
                                                 1918,1923,1928,1933,
                                                 1938,1943,1948,1953,
                                                 1958,1963,1968,1973,
                                                 1978,1983,1988,1993,
                                                 1998,2003,2008,2013,
                                                 2018)))
```

**Interpretación:** En el mapa de calor la franja de color azul representa las tasas de mortalidad de diabetes inferiores y la franja roja representa las tasas de mortalidad de diabetes superiores.

A nivel descriptivo se observa en el mapa de calor que las edades inferiores presentan menor tasa de mortalidad por diabetes en comparación a las edades mayores (aproximadamente superiores a 50 años de edad), siendo este comportamiento independiente de los períodos de tiempo y de las cohortes de nacimiento, es decir, indiscutiblemente cual período o cohorte de nacimiento sea, a medida que incrementa la edad, incrementa la tasa de mortalidad por diabetes.

Con respecto a los períodos de tiempo, estos presentan cambios en función de las edades y de las cohortes de nacimiento. Se puede observar que indiscutiblemente el período de tiempo analizado, a mayor edad mayor tasa de mortalidad por diabetes y a cohortes de nacimiento más longevas mayor tasa de mortalidad por diabetes.

Y con respecto a las cohortes de nacimiento se observa que, a medida que incrementa los grupos de edad y que incrementa los períodos de tiempo (períodos más recientes) en una misma cohorte de nacimiento, se incrementa la tasa de mortalidad por diabetes.

En conclusión, el mapa de calor refleja lo previamente evidenciado en los analísis de gráficos bidimensionales en donde:

-   La población perteneciente a un mismo grupo de edad experimenta una tasa de mortalidad por diabetes relativamente similar en los diferentes períodos de tiempo.

-   La población perteneciente a un mismo período de tiempo experimenta una tasa de mortalidad por diabetes más alta en edades más mayores en comparación con edades menores.

-   La población perteneciente a una misma cohorte de nacimiento experimenta una tasa de mortalidad por diabetes más alta en edades más mayores en comparación con edades menores.

-   La población perteneciente a una misma cohorte de nacimiento experimenta una tasa de mortalidad por diabetes más alta en períodos recientes en comparación con períodos más antiguos.

-   La población perteneciente a un mismo periodo de tiempo experimenta una tasa de mortalidad por diabetes más alta en cohortes de nacimiento más longevas en comparación a cohortes de nacimiento más jóvenes.

-   La población perteneciente a un mismo grupo de edad experimenta una tasa de mortalidad por diabetes relativamente similar en las diferentes cohortes de nacimiento.

A continuación se realiza los gráficos tridimensionales con la finalidad de evaluar este comportamiento de una manera más precisa

## 5. Análisis descriptivo con gráfico tridimensional

-   Gráfico tridimensional sin etiquetas

```{r}
bd_long_dm$age_group_numeric <- as.numeric(as.factor(bd_long_dm$age_group))
bd_long_dm$period_group_numeric <- as.numeric(as.factor(bd_long_dm$period_group))
bd_long_dm$cohort_group_numeric <- as.numeric(as.factor(bd_long_dm$cohort_group))

bd_long_dm$mortality_rate_log <- log10(bd_long_dm$mortality_rate)

plot3D_1 <- plot_ly(bd_long_dm, 
                x = ~age_group_numeric, 
                y = ~period_group_numeric, 
                z = ~cohort_group_numeric, 
                type = "scatter3d", 
                mode = "markers", 
                color = ~mortality_rate_log,
                marker = list(colorscale = "Viridis", 
                              cmin = min(bd_long_dm$mortality_rate_log), 
                              cmax = max(bd_long_dm$mortality_rate_log),  
                              colorbar = list(title = "log10 Mortality Rate"))) %>%
  layout(scene = list(xaxis = list(title = 'Age Group'),
                      yaxis = list(title = 'Period Group'),
                      zaxis = list(title = 'Cohort Group'),
                      aspectmode = "cube"), 
         title = "Gráfico 3D Mortalidad de diabetes mellitus por Grupos de Edad, Periodo y Cohorte")

plot3D_1
```

-   Gráfico tridimensional con etiquetas

```{r}
age_group_labels <- c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", 
                      "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", 
                      "60-64", "65-69", "70-74", "75-79", "80-84", "85+")

period_group_labels <- c("1983-1987", "1988-1992", "1993-1997", 
                         "1998-2002", "2003-2007", "2008-2012", 
                         "2013-2017", "2018-2022")

cohort_group_labels <- c("1898-1902", "1903-1907", "1908-1912", 
                         "1913-1917", "1918-1922", "1923-1927", 
                         "1928-1932", "1933-1937", "1938-1942", 
                         "1943-1947", "1948-1952", "1953-1957", 
                         "1958-1962", "1963-1967", "1968-1972", 
                         "1973-1977", "1978-1982", "1983-1987", 
                         "1988-1992", "1993-1997", "1998-2002", 
                         "2003-2007", "2008-2012", "2013-2017", 
                         "2018-2022")

plot3D_2 <- plot_ly(bd_long_dm, 
                x = ~age_group_numeric, 
                y = ~period_group_numeric, 
                z = ~cohort_group_numeric, 
                type = "scatter3d", 
                mode = "markers", 
                color = ~mortality_rate_log,
                marker = list(colorscale = "Viridis", 
                              cmin = min(bd_long_dm$mortality_rate_log), 
                              cmax = max(bd_long_dm$mortality_rate_log),  
                              colorbar = list(title = "log10 Mortality Rate"))) %>%
  layout(scene = list(xaxis = list(title = 'Age Group', tickvals = 1:length(age_group_labels), ticktext = age_group_labels),
                      yaxis = list(title = 'Period Group', tickvals = 1:length(period_group_labels), ticktext = period_group_labels),
                      zaxis = list(title = 'Cohort Group', tickvals = 1:length(cohort_group_labels), ticktext = cohort_group_labels),
                      aspectmode = "cube"),
         title = "Gráfico 3D Mortalidad de diabetes mellitus por Grupos de Edad, Periodo y Cohorte")

plot3D_2
```

**Interpretación:** En el gráfico tridimensional la escala de color azul oscura representa la menores tasas de mortalidad por diabetes y el color amarillo las mayores tasas de mortalidad por diabetes.

Se puede observar que las mayores tasas de mortalidad por diabetes se estan presentando en las edades mayores, en los períodos de tiempo más recientes y en las cohortes de nacimiento más longevas (puntos más amarillos y verdes claro).

Por su parte, las menores tasas de mortalidad por diabetes se estan presentando en las edades más jóvenes, en cohortes de nacimiento más jovénes y en los períodos de tiempo más recientes (puntos más verdes oscuros y azul oscuro).

Sin embargo, este comportamiento inusual del período de tiempo (tanto mayores como menores tasas de mortalidad en períodos más recientes) pueda deverse a que exista un efecto de la edad y un efecto de la cohorte de nacimiento sobre el período. En el cual, los períodos de tiempo que presentan menos mortalidad por diabetes son en los que confluyen edades menores y cohortes de nacimiento más jóvenes, por su parte, los períodos de tiempo en los cuales se presenta mayor mortalidad por diabetes son en los cuales confluyen edades mayores y cohortes de nacimiento más longevas.

***Por tal motivo,***

**Se hace necesario identificar con modelos de regresión los potenciales efectos independientes de la edad, el período y la cohorte de nacimiento sobre la tasa de mortalidad de diabetes**. Debido a que por medio de los gráficos descriptivos bidimensionales se ha identificado un potencial efecto de período y de edad sobre la cohorte de nacimiento y un potencial efecto de la edad y de la cohorte de nacimiento sobre el período calendario, **se hace indispensable poder separar estos efectos de manera independiente**, los cuales serán evaluados por medio de los modelos de regresión simples y múltiples.

***Efecto de la edad:*** Cambio en la tasa de mortalidad por diabetes de acuerdo a la edad, idependientemente de la cohorte de nacimiento y del tiempo calendario.

***Efecto de cohorte:*** Cambio en la tasa de mortalidad por diabetes de acuerdo a la cohorte de nacimiento (año de nacimiento), independientemente de la edad y del tiempo calendario.

***Efecto de período:*** Cambio en la tasa de mortalidad por diabetes de acuerdo al período calendario (en algún momento específico del tiempo, independientemente de la edad y de la cohorte de nacimiento.

## 6. Modelos de regresión de quasi-poisson simples

-   Organizar las bases de datos de tabla de Lexis en formato edad y periodo con las respectivas etiquetas

```{r,warning=FALSE}
bd_lexis_f_dm_a_p <- apcheader(r=bd_lexis_f_dm, 
                               agestart=0, 
                               yearstart=1983, 
                               agespan=5, 
                               yearspan=5, 
                               head=F)
```

```{r,warning=FALSE}
bd_lexis_p_dm_a_p <- apcheader(r=bd_lexis_p_dm, 
                               agestart=0, 
                               yearstart=1983, 
                               agespan=5, 
                               yearspan=5, 
                               head=F)
```

```{r,warning=FALSE}
bd_lexis_t_dm_a_p <- apcheader(r=bd_lexis_t_dm, 
                               agestart=0, 
                               yearstart=1983, 
                               agespan=5, 
                               yearspan=5, 
                               head=F)
```

**Algunas consideraciones generales sobre los modelos de regresión quasi-Poisson:**

**Modelo simple de edad:**

-   En el modelo de efecto de la edad supone que para cada combinación de edad (i) y período (j), se espera que el número de casos siga una distribución de Poisson, donde el logaritmo del valor esperado de la tasa del evento corresponde a una función lineal del efecto de la variable edad. Es decir, a medida que el efecto de la edad aumenta o dismunuye se espera que la variable dependiente aumente o disminuya de manera proporcional. Adicionalmente, la estructura de datos es equilibrada, lo que significa que existe el mismo número de observaciones de período para cada efecto de edad. El modelo produce estimaciones consistentes a medida que el tamaño de muestra (períodos) aumenta al infinito.

-   El modelo de efecto de la edad presenta "a" parámetros (que corresponde a cada parámetro estimado para cada nivel de la edad) y a\*(p-1) grados de libertad, en donde, p representa los grupos de períodos analizados. En este modelo de edad se estiman 18 parámetros con 18\*(8-1) = 126 grados de libertad.

**Modelo simple de período:**

-   En el modelo de efecto de período se supone que para cada combinación de edad (i) y período (j), se espera que el número de casos siga una distribución de Poisson, donde el logaritmo del valor esperado de la tasa del evento corresponde a una función lineal del efecto de la variable período. Es decir, a medida que el efecto del período aumenta o dismunuye se espera que la variable dependiente aumente o disminuya de manera proporcional. Adicionalmente, la estructura de datos es equilibrada, lo que significa que existe el mismo número de observaciones de edad para cada efecto de período. El modelo produce estimaciones consistentes a medida que el tamaño de muestra (edad) aumenta al infinito.

-   El modelo de efecto de período presenta "p" parámetros (que corresponde a cada parámetro estimado para cada nivel del período) y p\*(a-1) grados de libertad, en donde, a representa los grupos de edades analizadas. En este modelo de período se estiman 8 parámetros con 8\*(18-1) = 136 grados de libertad.

**Modelo simple de cohorte:**

-   En el modelo de efecto de la cohorte se supone que para cada combinación de edad (i) y período (j), se espera que el número de casos siga una distribución de Poisson, donde el logaritmo del valor esperado de la tasa del evento corresponde a una función lineal del efecto de la variable cohorte. Es decir, a medida que el efecto de la cohorte aumenta o dismunuye se espera que la variable dependiente aumente o disminuya de manera proporcional. Sin embargo, la estructura de datos esta desequilibrada para el modelo de efecto cohorte, en donde cada parámetro de cohorte presenta diferentes número de observaciones, siendo una sola observación por ejemplo para la cohorte más antigua y más jóven.

-   El modelo de efecto de cohorte presenta "a+p-1" parámetros (que corresponde a cada parámetro estimado para cada nivel de las cohortes) y (a-1) \* (p-1) grados de libertad, en donde, a representa los grupos de edades analizadas y p los grupos de períodos analizados. En este modelo de cohorte se estiman 25 parámetros con (18-1) \* (8-1) = 119 grados de libertad. Sin embargo, dado que se requiere que la edad y el período se incremente hasta el infinito, este modelo conduce a un número divergente de efectos de cohorte, por lo cuál, no es muy recomendable en la práctica un modelo solo con efecto cohorte.

**Modelo de edad-período:**

-   El modelo de edad-periodo sigue una distribución Poisson, donde el logarítmo del valor esperado de la tasa del evento corresponde a una función lineal tanto de los efectos de la edad como los del período. El modelo edad-período tiene una estructura de datos balanceada. Cada efecto de edad tienen "p" observaciones y cada efecto de período tiene "a" observaciones. El modelo presenta a+p-1 parámetros y (a-1) \* (p-1) grados de libertad. En este caso el modelo estima 25 parámetros con (18-1) \* (8-1) = 119 grados de libertad.

**Modelo de edad-cohorte:**

-   El modelo de edad-cohorte sigue una distribución Poisson, donde el logarítmo del valor esperado de la tasa del evento corresponde a una función lineal tanto de los efectos de la edad como los efectos de la cohorte. El modelo edad-cohorte tiene una estructura de datos desbalanceada. Cada efecto de cohorte tienen diversas cantidad de observaciones y cada efecto de edadtiene "p" observaciones. El modelo presenta 2a+p-2 parámetros y (a-1) \* (p-2) grados de libertad. En este caso el modelo estima 42 parámetros con 102 grados de libertad.

**Deviance:**

-   Los deviance permite cuantificar cuanto se desvían los datos observados de los valores predichos por el modelo. A menor deviance mejor ajuste el modelo. Adicionalmente, existe un mejor ajuste del modelo a medida que el deviance y los grados de libertad de se acercan entre sí. Significa que el modelo es capaz de explicar la variabilidad observada en los datos sin tener demasiados parámetros.

**Valor p de bondad de ajuste del modelo:**

-   El valor p de la bondad de ajuste del modelo a partir de los deviance sigue una distribución chi-cuadrado, en donde la hipótesis nula es "el modelo es apropiado" y la hipótesis alterna es "el modelo no es apropiado". En términos generales si los deviance son mayores que el valor critico de la distribución chi-cuadrado se rechaza la hipótesis nula.

**Parámetro de dispersión:**

-   El parámetro de dispersión corresponde a el valor crítico de la distribución chi-cuadrado del modelo dividido por los grados de libertad. A mayor valor del parámetro de dispersión significa que la varianza observada es mayor que la media esperada bajo un modelo de Poisson estándar, lo que indica que cierta variabilidad de la variable desenlace no esta siendo capturada por el modelo.

**Modelo simple del efecto de la edad, como variable independiente, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_A <- apcglmfit(r=bd_lexis_t_dm_a_p, header=T, n.risk= bd_lexis_p_dm_a_p, Scale=1e-5, apcmodel="A", fam="qlik", Plot=T)
model_A
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_A)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_A <- model_A$parameter[, "Estimate"]
std_errors_model_A <- model_A$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_A <- parameters_model_A - 1.96 * std_errors_model_A
conf_int_upper_model_A <- parameters_model_A + 1.96 * std_errors_model_A

# Mostrar los intervalos de confianza
conf_int_model_A <- data.frame(lower = conf_int_lower_model_A, upper = conf_int_upper_model_A)
conf_int_model_A
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_A <- exp(model_A$parameter[, "Estimate"])
coef_exp_model_A <- round(coef_exp_model_A, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_A <- exp(model_A$parameter[, "Estimate"] - 1.96 * model_A$parameter[, "Std. Error"])
conf_int_lower_exp_model_A <- round(conf_int_lower_exp_model_A, 2)

conf_int_upper_exp_model_A <- exp(model_A$parameter[, "Estimate"] + 1.96 * model_A$parameter[, "Std. Error"])
conf_int_upper_exp_model_A <- round(conf_int_upper_exp_model_A, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_A <- data.frame(Rate_Ratio = coef_exp_model_A,
                          lower = conf_int_lower_exp_model_A,
                          upper = conf_int_upper_exp_model_A)

# Mostrar los resultados
results_exp_model_A
```

**Interpretación:**

Interpretación para los coeficientes de regresión basado en las pruebas de hipótesis:

H0: El coeficiente de regresión de cada categoría de edad es igual a 0

Ha: El coeficiente de regresión de cada categoría de edad es diferente de 0

Existe evidencia estadística para concluir que los coeficientes de regresión de cada categoría de la variable edad son diferentes de 0, es decir, son estadísticamente significativos. Sin embargo, el modelo simple de edad presenta poca bondad de ajuste, al analizar el valor p de la prueba de bondad de ajuste del modelo según la distribución chi-cuadrado. Adicionalmente, el valor del parámetro de dispersión es considerablemente alto.

Al analizar la razón de tasa de mortalidad se observa que a medida que incrementa la edad se incrementa la tasa de mortalidad por diabetes mellitus en comparación a la tasa media general, a excepción de la edad de 5 a 9 años en la cual la tasa de mortalidad no sigue la tendencia del aumento, panorama previamente evidenciado en los análisis descriptivos.

**Modelo simple del efecto del período, como variable independiente, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_P <- apcglmfit(r=bd_lexis_t_dm_a_p, header=T, n.risk= bd_lexis_p_dm_a_p, Scale=1e-5, apcmodel="P", fam="qlik", Plot=T)
model_P
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_P)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_P <- model_P$parameter[, "Estimate"]
std_errors_model_P <- model_P$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_P <- parameters_model_P - 1.96 * std_errors_model_P
conf_int_upper_model_P <- parameters_model_P + 1.96 * std_errors_model_P

# Mostrar los intervalos de confianza
conf_int_model_P <- data.frame(lower = conf_int_lower_model_P, upper = conf_int_upper_model_P)
conf_int_model_P
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_P <- exp(model_P$parameter[, "Estimate"])
coef_exp_model_P <- round(coef_exp_model_P, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_P <- exp(model_P$parameter[, "Estimate"] - 1.96 * model_P$parameter[, "Std. Error"])
conf_int_lower_exp_model_P <- round(conf_int_lower_exp_model_P, 2)

conf_int_upper_exp_model_P <- exp(model_P$parameter[, "Estimate"] + 1.96 * model_P$parameter[, "Std. Error"])
conf_int_upper_exp_model_P <- round(conf_int_upper_exp_model_P, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_P <- data.frame(Rate_Ratio = coef_exp_model_P,
                          lower = conf_int_lower_exp_model_P,
                          upper = conf_int_upper_exp_model_P)

# Mostrar los resultados
results_exp_model_P
```

**Interpretación:**

Interpretación para los coeficientes de regresión basado en las pruebas de hipótesis:

H0: El coeficiente de regresión de cada categoría de período es igual a 0

Ha: El coeficiente de regresión de cada categoría de período es diferente de 0

Existe evidencia estadística para concluir que los coeficientes de regresión de cada categoría de la variable período son iguales de 0, es decir, no son estadísticamente significativos. En consecuencia, el modelo simple de período presenta poca bondad de ajuste, al analizar el valor p de la prueba de bondad de ajuste del modelo según la distribución chi-cuadrado. Adicionalmente, el valor del parámetro de dispersión es considerablemente alto, mucho mayor que el modelo del efecto de la edad.

Al analizar la razón de tasa de mortalidad de cada período en comparación a la tasa media general, se observa que, todos los intervalos de confianza incluye el valor de nulidad, por tal motivo, modelo de período simple no es adecuadao para evaluar los cambios en la tasa de mortalidad por diabetes.

**Modelo simple del efecto de la cohorte, como variable independiente, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_C <- apcglmfit(r=bd_lexis_t_dm_a_p, header=T, n.risk= bd_lexis_p_dm_a_p, Scale=1e-5, apcmodel="C", fam="qlik", Plot=T)
model_C
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_C)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_C <- model_C$parameter[, "Estimate"]
std_errors_model_C <- model_C$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_C <- parameters_model_C - 1.96 * std_errors_model_C
conf_int_upper_model_C <- parameters_model_C + 1.96 * std_errors_model_C

# Mostrar los intervalos de confianza
conf_int_model_C <- data.frame(lower = conf_int_lower_model_C, upper = conf_int_upper_model_C)
conf_int_model_C
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_C <- exp(model_C$parameter[, "Estimate"])
coef_exp_model_C <- round(coef_exp_model_C, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_C <- exp(model_C$parameter[, "Estimate"] - 1.96 * model_C$parameter[, "Std. Error"])
conf_int_lower_exp_model_C <- round(conf_int_lower_exp_model_C, 2)

conf_int_upper_exp_model_C <- exp(model_C$parameter[, "Estimate"] + 1.96 * model_C$parameter[, "Std. Error"])
conf_int_upper_exp_model_C <- round(conf_int_upper_exp_model_C, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_C <- data.frame(Rate_Ratio = coef_exp_model_C,
                          lower = conf_int_lower_exp_model_C,
                          upper = conf_int_upper_exp_model_C)

# Mostrar los resultados
results_exp_model_C
```

**Interpretación:**

Interpretación para los coeficientes de regresión basado en las pruebas de hipótesis:

H0: El coeficiente de regresión de cada categoría de cohorte es igual a 0

Ha: El coeficiente de regresión de cada categoría de cohorte es diferente de 0

Existe evidencia estadística para concluir que solo los coeficientes de regresión de las cohortes de nacimiento de los años 1903 a 1948 son diferentes de 0, es decir, son estadísticamente significativas. En consecuencia, el modelo simple de cohorte presenta poca bondad de ajuste, al analizar el valor p de la prueba de bondad de ajuste del modelo según la distribución chi-cuadrado. Adicionalmente, el valor del parámetro de dispersión es considerablemente alto, aunque menor que el obtenido en el modelo de período.

Al analizar la razón de tasa de mortalidad de cada cohorte en comparación a la tasa media general, se observa que, existe una tendencia a la disminución a medidia que las cohortes son más jóvenes, a pesar de la no significancia estadística de algunas de las razones de tasa de mortalidad por diabetes mellitus.

-   Medidas de bondad de ajuste y resultados generales de los modelos de regresión quasi-poisson simples

| Modelo  | Deviance | Grados de libertad | Parámetro de dispersión |
|---------|----------|--------------------|-------------------------|
| Edad    | 12653,9  | 126                | 97,51091                |
| Periodo | 827673   | 136                | 15307,72                |
| Cohorte | 164066,5 | 119                | 1454,066                |

## 7. Modelos de regresión de quasi-poisson múltiples

**Modelo múltiple del efecto de la edad y el período, como variables independientes, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_AP <- apcglmfit(r=bd_lexis_t_dm_a_p, header=T, n.risk= bd_lexis_p_dm_a_p, Scale=1e-5, apcmodel="AP", fam="qlik", Plot=T)
model_AP
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_AP)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_AP <- model_AP$parameter[, "Estimate"]
std_errors_model_AP <- model_AP$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_AP <- parameters_model_AP - 1.96 * std_errors_model_AP
conf_int_upper_model_AP <- parameters_model_AP + 1.96 * std_errors_model_AP

# Mostrar los intervalos de confianza
conf_int_model_AP <- data.frame(lower = conf_int_lower_model_AP, upper = conf_int_upper_model_AP)
conf_int_model_AP
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_AP <- exp(model_AP$parameter[, "Estimate"])
coef_exp_model_AP <- round(coef_exp_model_AP, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_AP <- exp(model_AP$parameter[, "Estimate"] - 1.96 * model_AP$parameter[, "Std. Error"])
conf_int_lower_exp_model_AP <- round(conf_int_lower_exp_model_AP, 2)

conf_int_upper_exp_model_AP <- exp(model_AP$parameter[, "Estimate"] + 1.96 * model_AP$parameter[, "Std. Error"])
conf_int_upper_exp_model_AP <- round(conf_int_upper_exp_model_AP, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_AP <- data.frame(Rate_Ratio = coef_exp_model_AP,
                          lower = conf_int_lower_exp_model_AP,
                          upper = conf_int_upper_exp_model_AP)

# Mostrar los resultados
results_exp_model_AP
```

**Interpretación:**

Interpretación para los coeficientes de regresión basado en las pruebas de hipótesis:

H0: El coeficiente de regresión de cada categoría de edad y período es igual a 0

Ha: El coeficiente de regresión de cada categoría de edad y período es diferente de 0

Existe evidencia estadística para concluir que los coeficientes de regresión de las edades son diferentes de 0, es decir, son estadísticamente significativos. Por su parte, los coeficientes de regresión de los períodos 1993 y 2008 no son estadísticamente significativos. A pesar que la prueba de hipótesis de bondad de ajuste refleja que el modelo no se ajsuta bien, los deviance y el parámetro de dispersión disminuyó considerablemente en comparación a los modelos de regresión simples.

Es de recordar que en estas circunstancias la prueba de hipótesis de bondad de ajuste debe de interpretarse con cautela, debido a que es influenciada por el tamaño muestral, más bien se aconseja la comparación de los deviance y la dispersión del modelo.

Al analizar las razones de tasa de mortalidad, se evidencia que a mayor edad mayor tasa de mortalidad por diabetes en comparación a la media general, manteniendo las demás variables constantes. Con relación a los períodos, estos experimentan diferentes fluctuaciones en el tiempo, experimentando en los primeros periodos un aumento en la tasa de mortalidad y luego una disminución, manteniendo las demás variables constantes.

En este modelo se evidencia como al ajustar por edad, los efectos de los períodos cobran significancia estadística, esto posiblemente se deba a un potencial efecto de la edad sobre los períodos, el cual fue detectado en los análisis descriptivos de los gráficos bidimensionales.

**Modelo múltiple del efecto de la edad y la cohorte, como variables independientes, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_AC <- apcglmfit(r=bd_lexis_t_dm_a_p, header=T, n.risk= bd_lexis_p_dm_a_p, Scale=1e-5, apcmodel="AC", fam="qlik", Plot=T)
model_AC
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_AC)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_AC <- model_AC$parameter[, "Estimate"]
std_errors_model_AC <- model_AC$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_AC <- parameters_model_AC - 1.96 * std_errors_model_AC
conf_int_upper_model_AC <- parameters_model_AC + 1.96 * std_errors_model_AC

# Mostrar los intervalos de confianza
conf_int_model_AC <- data.frame(lower = conf_int_lower_model_AC, upper = conf_int_upper_model_AC)
conf_int_model_AC
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_AC <- exp(model_AC$parameter[, "Estimate"])
coef_exp_model_AC <- round(coef_exp_model_AC, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_AC <- exp(model_AC$parameter[, "Estimate"] - 1.96 * model_AC$parameter[, "Std. Error"])
conf_int_lower_exp_model_AC <- round(conf_int_lower_exp_model_AC, 2)

conf_int_upper_exp_model_AC <- exp(model_AC$parameter[, "Estimate"] + 1.96 * model_AC$parameter[, "Std. Error"])
conf_int_upper_exp_model_AC <- round(conf_int_upper_exp_model_AC, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_AC <- data.frame(Rate_Ratio = coef_exp_model_AC,
                          lower = conf_int_lower_exp_model_AC,
                          upper = conf_int_upper_exp_model_AC)

# Mostrar los resultados
results_exp_model_AC
```

**Interpretación:**

Interpretación para los coeficientes de regresión basado en las pruebas de hipótesis:

H0: El coeficiente de regresión de cada categoría de edad y cohorte es igual a 0

Ha: El coeficiente de regresión de cada categoría de edad y cohorte es diferente de 0

Existe evidencia estadística para concluir que los coeficientes de regresión de las edades son diferentes de 0, es decir, son estadísticamente significativos, a excepción de la edad de 45 años. Por su parte, los coeficientes de regresión de las cohortes de 1903, 1958, 1963, 1968, 1973, 1978, 1983, 1988, 2013 y 2018 no son estadísticamente significativos. A pesar que la prueba de hipótesis de bondad de ajuste refleja que el modelo no se ajusta bien, los deviance y el parámetro de dispersión disminuyó considerablemente en comparación a los modelos de regresión simples, aunque el parámetro de dispersión aumentó en comparación con el modelo de edad-período.

Es de recordar que en estas circunstancias la prueba de hipótesis de bondad de ajuste debe de interpretarse con cautela, debido a que es influenciada por el tamaño muestral, más bien se aconseja la comparación de los deviance y la dispersión del modelo.

Al analizar las razones de tasa de mortalidad, se evidencia que a mayor edad mayor tasa de mortalidad por diabetes en comparación a la media general, manteniendo las demás variables constantes. Con relación a las cohortes, estos experimentan diferentes fluctuaciones en el tiempo, experimentando en los primeros periodos un aumento en la tasa de mortalidad y luego una disminución aproximadamente desde la cohorte de nacimiento de 1933, manteniendo las demás variables constantes.

En este modelo se evidencia como al ajustar por edad, los efectos de algunas de las cohortes de nacimiento cobran significancia estadística y mejoran la precisión de los intervalos de confianza, esto posiblemente se deba a un potencial efecto de la edad sobre las cohortes, el cual fue detectado en los análisis descriptivos de los gráficos bidimensionales.

-   Medidas de bondad de ajuste de los modelos de regresión quasi-poisson simples y múltiples

+--------------+--------------+--------------------+--------------------------+
| Modelo       | Deviance     | Grados de libertad | Parámetros de dispersión |
+==============+==============+====================+==========================+
| Edad         | 12653,9      | 126                | 97,51091                 |
+--------------+--------------+--------------------+--------------------------+
| Período      | 827673       | 136                | 15307,72                 |
+--------------+--------------+--------------------+--------------------------+
| Cohorte      | 164066,5     | 119                | 1454,066                 |
+--------------+--------------+--------------------+--------------------------+
| Edad-Período | 5008,082     | 119                | 39,48436                 |
+--------------+--------------+--------------------+--------------------------+
| Edad-Cohorte | 4877,732     | 102                | 48,66681                 |
+--------------+--------------+--------------------+--------------------------+

**Nota:** Al realizar los modelos de regresión de quasi-poisson simples y múltiples **es evidente que al ingresar más variables independientes al modelo mejora la bondad de ajuste y el parámetro de dispersión**, adicionalmente, **se logra controlar los efectos de la edad sobre el período y sobre la cohorte evidenciados en los gráficos bidimensionales**. ***Por tal motivo, un modelo de edad, período, cohorte puede reflejar de mejor manera el efecto de cada una de estás variables sobre la tasa de mortalidad por diabetes.***

## **8. Modelo de regresión de quasi-poisson multiple completo y gráficos de los efectos ajustados**

**Modelo múltiple del efecto de la edad, el período y la cohorte, como variables independientes, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson múltiple con estimador intrínseco:*

```{r}
model_APC <- apcglmfit(r=bd_lexis_t_dm_a_p, header=T, n.risk= bd_lexis_p_dm_a_p, Scale=1e-5, apcmodel="APC", fam="qlik", Plot=T, apc = 0)
model_APC
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_APC)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_APC <- model_APC$parameter[, "Estimate"]
std_errors_model_APC <- model_APC$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_APC <- parameters_model_APC - 1.96 * std_errors_model_APC
conf_int_upper_model_APC <- parameters_model_APC + 1.96 * std_errors_model_APC

# Mostrar los intervalos de confianza
conf_int_model_APC <- data.frame(lower = conf_int_lower_model_APC, upper = conf_int_upper_model_APC)
conf_int_model_APC
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_APC <- exp(model_APC$parameter[, "Estimate"])
coef_exp_model_APC <- round(coef_exp_model_APC, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_APC <- exp(model_APC$parameter[, "Estimate"] - 1.96 * model_APC$parameter[, "Std. Error"])
conf_int_lower_exp_model_APC <- round(conf_int_lower_exp_model_APC, 2)

conf_int_upper_exp_model_APC <- exp(model_APC$parameter[, "Estimate"] + 1.96 * model_APC$parameter[, "Std. Error"])
conf_int_upper_exp_model_APC <- round(conf_int_upper_exp_model_APC, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_APC <- data.frame(Rate_Ratio = coef_exp_model_APC,
                          lower = conf_int_lower_exp_model_APC,
                          upper = conf_int_upper_exp_model_APC)

# Mostrar los resultados
results_exp_model_APC
```

-   *Gráfico efectos de la edad:*

```{r, warning=FALSE}
edad_general <- readxl::read_excel("resultados_modelo_global_edad.xlsx")

edad_general$grupo <- edad_general$grupo |> 
  replace_na() |> 
  factor(ordered = T, levels = c(
    "0-4", "5-9", "10-14", "15-19", "20-24", "25-29", 
    "30-34", "35-39", "40-44", "45-49", 
    "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+") )
edad_general

ggplot(edad_general, aes(x=grupo, y=estimador, group = 1)) +
  geom_ribbon(aes(ymin=ic_liminf, ymax=ic_limsup), fill = "lightblue", alpha = 0.5) +
  geom_point(color="blue", size = 3) +
  geom_line(color = "blue", size = 1, linetype = "dashed") +
  labs(x="Age group", y="Regression coefficient", 
       title="Age effects on DM mortality (DM)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 16),
        legend.position = "none")
```

-   *Gráfico efectos del período:*

```{r, warning=FALSE}
periodo_general <- readxl::read_excel("resultados_modelo_global_periodo.xlsx")

periodo_general$grupo <- periodo_general$grupo |> 
  replace_na() |> 
  factor(ordered = T, levels = c(
    "1983-1987", "1988-1992", "1993-1997", 
    "1998-2002", "2003-2007", "2008-2012", 
    "2013-2017", "2018-2022") )
periodo_general

ggplot(periodo_general, aes(x=grupo, y=estimador, group = 1)) +
  geom_ribbon(aes(ymin=ic_liminf, ymax=ic_limsup), fill = "salmon", alpha = 0.5) +
  geom_point(color="red", size = 3) +
  geom_line(color = "red", size = 1, linetype = "dashed") +
  labs(x="Period group", y="Regression coefficient", 
       title="Period effects on DM mortality (B)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 16),
        legend.position = "none")
```

-   *Gráfico efectos de la cohorte:*

```{r,warning=FALSE}
cohorte_general <- readxl::read_excel("resultados_modelo_global_cohorte.xlsx")

cohorte_general$grupo <- cohorte_general$grupo |> 
  replace_na() |> 
  factor(ordered = T, levels = c(
    "1898-1902", "1903-1907", "1908-1912", 
    "1913-1917", "1918-1922",
    "1923-1927", "1928-1932", "1933-1937",
    "1938-1942", "1943-1947",
    "1948-1952", "1953-1957", "1958-1962", 
    "1963-1967", "1968-1972",
    "1973-1977", "1978-1982", "1983-1987", 
    "1988-1992", "1993-1997",
    "1998-2002", "2003-2007", "2008-2012", 
    "2013-2017", "2018-2022") )
cohorte_general

ggplot(cohorte_general, aes(x=grupo, y=estimador, group = 1)) +
  geom_ribbon(aes(ymin=ic_liminf, ymax=ic_limsup), fill = "lightgreen", alpha = 0.5) +
  geom_point(color="green", size = 3) +
  geom_line(color = "green", size = 1, linetype = "dashed") +
  labs(x="Cohort group", y="Regression coefficient", 
       title="Cohort effects on DM mortality (C)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 16),
        legend.position = "none")
```

**Interpretación:**

Interpretación para los coeficientes de regresión basado en las pruebas de hipótesis:

H0: El coeficiente de regresión de cada categoría de edad, período y cohorte es igual a 0

Ha: El coeficiente de regresión de cada categoría de edad, período y cohorte es diferente de 0

Existe evidencia estadística para concluir que los coeficientes de regresión de las edades y de los períodos son diferentes de 0, es decir, son estadísticamente significativos. Para el caso de los coeficientes de regresión de las cohortes solo las cohortes de nacimiento de 1963 y 1968 no fueron estadísticamente significativas. Con relación a los deviance disminuyó considerablemente en comparación a los modelos de un factor y de dos factores, de igual forma, el parámetro de dispersión mejoró considerablemente.

Con respecto a la edad la tasa de mortalidad por diabetes se incrementa conforme incrementa las edades en comparación con la tasa media general, manteniendo las demás variables en un nivel constante, a excepción de la edad de 5 a 9 años, la cual no sigue la tendencia de los demás grupos de edad. Con respecto a los períodos, existe una tendencia al aumento en la tasa de mortalidad por diabetes en los períodos 1983, 1988, 1993, 1998 y 2003 en comparación a la tasa media general, manteniendo las demás variables constantes. En el período 2008 y 2013 se estabilizó y luego en el 2018 a 2022 nuevamete incrementó. Y finalmente, con respecto a las cohortes de nacimiento, se evidencia un aumento nen la tasa de mortalidad por diabetes hasta la cohorte de nacimiento de 1913, y luego una disminución progresiva en la tasa de mortalidad por diabetes desde la cohorte de nacimiento de 1923.

-   Medidas de bondad de ajuste de los modelos de regresión quasi-poisson simples y múltiples

+----------------------+--------------+--------------------+-------------------------+
| Modelo               | Deviance     | Grados de libertad | Parámetro de dispersión |
+======================+==============+====================+=========================+
| Edad                 | 12653,9      | 126                | 97,51091                |
+----------------------+--------------+--------------------+-------------------------+
| Período              | 827673       | 136                | 15307,72                |
+----------------------+--------------+--------------------+-------------------------+
| Cohorte              | 164066,5     | 119                | 1454,066                |
+----------------------+--------------+--------------------+-------------------------+
| Edad- Péríodo        | 5008,082     | 119                | 39,78436                |
+----------------------+--------------+--------------------+-------------------------+
| Edad-Cohorte         | 4877,732     | 102                | 48,66681                |
+----------------------+--------------+--------------------+-------------------------+
| Edad-Período-Cohorte | 618,7297     | 96                 | 6,448297                |
+----------------------+--------------+--------------------+-------------------------+

# Análisis según sexo masculino

## 1. Análisis descriptivo univariado

**Variable dependiente:**

Conteo de fallecimientos por diabetes mellitus

-   Medidas de resumen:

```{r}
descr(bd_long_dm_h$deaths)
```

-   Gráfico de densidad:

```{r}
ggplot(bd_long_dm_h,         aes(x = deaths, fill = "Density")) +   geom_density(alpha = 0.7, color = "darkblue", fill = "darkblue") +   labs(x = "Conteo fallecimientos", y = "Densidad") +   ggtitle("Gráfico de densidad del conteo de fallecimientos por diabetes mellitus según sexo masculino")
```

-   Gráfico boxplot:

```{r,warning=FALSE}
ggplot(bd_long_dm_h, aes(x = deaths)) +   geom_boxplot(color = "darkblue", alpha = 0.5) +   ggtitle("Boxplot del conteo de fallecimientos por diabetes mellitus según sexo masculino")
```

Tasa de mortalidad de diabetes mellitus por cada 100.000 personas

-   Medidas de resumen:

```{r}
descr(bd_long_dm_h$mortality_rate)
```

-   Gráfico de densidad:

```{r,warning=FALSE}
ggplot(bd_long_dm_h,         aes(x = mortality_rate, fill = "Density")) +   geom_density(alpha = 0.7, color = "darkblue", fill = "darkblue") +   labs(x = "Tasa cruda de mortalidad", y = "Densidad") +   ggtitle("Gráfico de densidad tasa cruda de mortalidad por diabetes mellitus según sexo masculino")
```

-   Gráfico boxplot:

```{r,warning=FALSE}
ggplot(bd_long_dm_h, aes(x = mortality_rate)) +   geom_boxplot(color = "darkblue", alpha = 0.5) +   ggtitle("Boxplot tasa cruda de mortalidad por diabetes mellitus según sexo masculino")
```

## 2. Análisis descriptivo bivariado

**Variable dependiente en función de los grupos de edad, grupos de período y grupos de cohorte de nacimiento:**

-   Conteo de fallecimientos por diabetes mellitus según grupos de edad

```{r}
bd_long_dm_h %>%   
  group_by(age_group) %>%   
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Frecuencia_Porcentual = round(sum(deaths) / sum(bd_long_dm_h$deaths) * 100, 2)
  ) %>%
  bind_rows(
    summarise(., 
              age_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos),   
              Frecuencia_Porcentual = round(sum(Frecuencia_Porcentual), 2))
  ) %>%
  knitr::kable()
```

-   Conteo de fallecimientos por diabetes mellitus según grupos de período

```{r}
bd_long_dm_h %>%   
  group_by(period_group) %>%   
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Frecuencia_Porcentual = round(sum(deaths) / sum(bd_long_dm_h$deaths) * 100, 2)
  ) %>%
  bind_rows(
    summarise(., 
              period_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos),     
              Frecuencia_Porcentual = round(sum(Frecuencia_Porcentual), 2))
  ) %>%
  knitr::kable()
```

-   Conteo de fallecimientos por diabetes mellitus según grupos de cohorte de nacimiento

```{r}
bd_long_dm_h %>%   
  group_by(cohort_group) %>%
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Frecuencia_Porcentual = round(sum(deaths) / sum(bd_long_dm_h$deaths) * 100, 2)
  ) %>%
  bind_rows(
    summarise(., 
              cohort_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos),
              Frecuencia_Porcentual = round(sum(Frecuencia_Porcentual), 2))
  ) %>%
  knitr::kable()
```

-   Tasa cruda de mortalidad por diabetes mellitus según grupos de edad

```{r}
bd_long_dm_h %>% 
  group_by(age_group) %>%   
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Poblacion = sum(population),
    Tasa_especifica = round((sum(deaths) / sum(population)) * 100000, 2)
  ) %>% 
  bind_rows(
    summarise(., 
              age_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Poblacion = sum(Poblacion),               
              Tasa_especifica = round((sum(Conteo_fallecimientos) / sum(Poblacion)) * 100000, 2))
  ) %>%   
  knitr::kable()
```

-   Tasa cruda de mortalidad por diabetes mellitus según grupos de período

```{r}
bd_long_dm_h %>% 
  group_by(period_group) %>%   
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Poblacion = sum(population),
    Tasa_especifica = round((sum(deaths) / sum(population)) * 100000, 2)
  ) %>%
  bind_rows(
    summarise(., 
              period_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Poblacion = sum(Poblacion),
              Tasa_especifica = round((sum(Conteo_fallecimientos) / sum(Poblacion)) * 100000, 2))
  ) %>%   
  knitr::kable()
```

-   Tasa cruda de mortalidad por diabetes mellitus según grupos de cohorte

```{r}
bd_long_dm_h %>%
  group_by(cohort_group) %>%   
  summarise(
    Conteo_fallecimientos = sum(deaths),     
    Poblacion = sum(population),     
    Tasa_especifica = round((sum(deaths) / sum(population)) * 100000, 2)
  ) %>%
  bind_rows(
    summarise(., 
              cohort_group = "Total",               
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Poblacion = sum(Poblacion),               
              Tasa_especifica = round((sum(Conteo_fallecimientos) / sum(Poblacion)) * 100000, 2))
  ) %>%   
  knitr::kable()
```

**Variable dependiente en función de la edad, el período y la cohorte (Gráficos unidimensionales):**

-   Gráfico boxplot en escala logaritmica para la tasa de mortalidad de diabetes según edad

```{r,message=FALSE,warning=FALSE}
#Colores para el gráfico 
coloresgg1_h <- c("#1f77b4",                  
                "#ff7f0e",                  
                "#2ca02c",                  
                "#d62728",                  
                "#9467bd",                  
                "#8c564b",                  
                "#e377c2",                  
                "#7f7f7f",                  
                "#bcbd22",                  
                "#17becf",                  
                "#aec7e8",                  
                "#ffbb78",                  
                "#98df8a",                  
                "#ff9896",                  
                "#c5b0d5",                  
                "#c49c94",                  
                "#f7b6d2",                  
                "#c7c7c7")  

# Especificar orden de los grupos de edad 
bd_long_dm_h$age_group <- factor(bd_long_dm_h$age_group,
                               levels = c("0-4", "5-9", "10-14",
                                          "15-19", "20-24", "25-29",
                                          "30-34", "35-39", "40-44",
                                          "45-49", "50-54", "55-59",
                                          "60-64", "65-69", "70-74",
                                          "75-79", "80-84", "85+"))  

# Grafico boxplot 
ggplot(bd_long_dm_h, 
       aes(x = age_group,                         
           y = log10(mortality_rate),                         
           fill = age_group)) +    
  geom_boxplot() +    
  scale_fill_manual(values = coloresgg1_h) +    
  labs(x = "Grupos de edad",         
       y = "Tasa de Mortalidad * 100.000 (log10)",         
       fill = "Grupos de edad") +   
  ggtitle("Tasa de mortalidad por DM según grupos de edad en hombres (A)") +    
  theme_minimal() +    
  theme(axis.text.x = element_text(color = "black", angle = 45, size = 18), 
        axis.text.y = element_text(color = "black", size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18))
```

-   Gráfico boxplot en escala logaritmica para la tasa de mortalidad de diabetes según períodos

```{r,message=FALSE,warning=FALSE}
#Colores para el gráfico 
coloresgg2_h <- c("#1f77b4",                  
                "#ff7f0e",                  
                "#2ca02c",                  
                "#d62728",                  
                "#9467bd",                  
                "#8c564b",                  
                "#e377c2",                  
                "#7f7f7f")  

# Especificar orden de los grupos de período 
bd_long_dm_h$period_group <- factor(bd_long_dm_h$period_group,
                                  levels = c("1983-1987", "1988-1992", "1993-1997",
                                             "1998-2002", "2003-2007", "2008-2012",                                               "2013-2017", "2018-2022"))  

# Grafico boxplot 
ggplot(bd_long_dm_h, 
       aes(x = period_group,                         
           y = log10(mortality_rate),                         
           fill = period_group)) +   
  geom_boxplot() +   
  scale_fill_manual(values = coloresgg2_h) +   
  labs(x = "Grupos de período",         
       y = "Tasa de Mortalidad de DM*100.000 (log10)",         
       fill = "Grupos de Período") +   
  ggtitle("Tasa de mortalidad por DM según grupos de período en hombres (B)") +   
  theme_minimal() +    
  theme(axis.text.x = element_text(color = "black", angle = 45, size = 18),
        axis.text.y = element_text(color = "black", size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18))
```

-   Gráfico boxplot en escala logaritmica para la tasa de mortalidad de diabetes según cohortes

```{r}
# Colores para el gráfico 
coloresgg3_h <- c("#1f77b4",                  
                "#ff7f0e",                  
                "#2ca02c",                  
                "#d62728",                  
                "#9467bd",                  
                "#8c564b",                  
                "#e377c2",                  
                "#7f7f7f",                 
                "#bcbd22",                 
                "#17becf",                 
                "#aec7e8",                 
                "#ffbb78",                 
                "#98df8a",                 
                "#ff9896",                 
                "#c5b0d5",                 
                "#c49c94",                 
                "#f7b6d2",                 
                "#c7c7c7",                 
                "#dbdb8d",                 
                "#9edae5",                 
                "#ad494a",                 
                "#8c6d31",                 
                "#e7ba52",                 
                "#9467bd",                 
                "#d6616b")  

# Especificar orden de los grupos de cohortes 
bd_long_dm_h$cohort_group <- factor(bd_long_dm_h$cohort_group,
                                  levels = c("1898-1902", "1903-1907", "1908-1912",                                               "1913-1917", "1918-1922","1923-1927",
                                             "1928-1932", "1933-1937","1938-1942", 
                                             "1943-1947","1948-1952", "1953-1957", 
                                             "1958-1962","1963-1967", "1968-1972",                                              "1973-1977", "1978-1982", "1983-1987",                                               "1988-1992", "1993-1997","1998-2002",
                                             "2003-2007", "2008-2012","2013-2017", 
                                             "2018-2022"))  

# Grafico boxplot 
ggplot(bd_long_dm_h, 
       aes(x = cohort_group,                         
           y = log10(mortality_rate),                         
           fill = cohort_group)) +   
  geom_boxplot() +   
  scale_fill_manual(values = coloresgg3_h) +   
  labs(x = "Grupos de Cohortes de nacimiento",         
       y = "Tasa de Mortalidad de DM*100.000 (log10)",        
       fill = "Grupos de Cohortes") +   
  ggtitle("Tasa de mortalidad por DM según grupos de cohorte en hombres (C)") +   
  theme_minimal() +   
  theme(axis.text.x = element_text(color = "black", angle = 45, size = 13),
        axis.text.y = element_text(color = "black", size = 18),
        legend.position = "top",
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18))
```

## 3. Análisis descriptivo con gráficos bidimensionales

**Variable dependiente en función de la edad, el período y la cohorte:**

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de la edad estratificado por periodos

```{r}
# Colores para cada uno de los grupos de período
coloresgg4_h <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf")

# Estilos de líneas para cada uno de los grupos de périodo
lineasgg4_h <- c("solid", 
            "dashed", 
            "dotted", 
            "dotdash", 
            "longdash", 
            "twodash", 
            "dotdash", 
            "longdash", 
            "dashed", 
            "dotted")

# Gráfico de línea
ggplot(bd_long_dm_h, 
       aes(x = factor(age_group), 
           y = log10(mortality_rate), 
           group = period_group, 
           color = factor(period_group), 
           linetype = factor(period_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg4_h) +  
  scale_linetype_manual(values = lineasgg4_h) +  
  labs(x = "Grupos de edad", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de período", linetype = "Grupos de período") +
  theme_light(base_size = 12) +  
  ggtitle("Tasa de Mortalidad DM según Edad y período en hombres (A)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))   
```

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de los períodos estratificado por grupos de edad

```{r}
# Colores para cada uno de los grupos de edad
coloresgg5_h <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7")

# Estilos de líneas para cada uno de los grupos de edad
lineasgg5_h <- c("solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed")

# Gráfico de línea
ggplot(bd_long_dm_h, 
       aes(x = factor(period_group), 
           y = log10(mortality_rate), 
           group = age_group, 
           color = factor(age_group), 
           linetype = factor(age_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg5_h) +  
  scale_linetype_manual(values = lineasgg5_h) +  
  labs(x = "Grupos de período", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de edad", linetype = "Grupos de edad") +
  theme_light(base_size = 12) +  
  ggtitle("Tasa de Mortalidad DM según período y edad en hombres (B)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))  +  
  guides(color = guide_legend(ncol = 6))
```

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de las cohortes de nacimiento estratificado por grupos de edad

```{r}
# Colores para cada uno de los grupos de edad
coloresgg6_h <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7")

# Estilos de líneas para cada uno de los grupos de edad
lineasgg6_h <- c("solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed")

# Gráfico de línea
ggplot(bd_long_dm_h, 
       aes(x = factor(cohort_group), 
           y = log10(mortality_rate), 
           group = age_group, 
           color = factor(age_group), 
           linetype = factor(age_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg6_h) +  
  scale_linetype_manual(values = lineasgg6_h) +  
  labs(x = "Grupos de cohortes de nacimiento", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de edad", linetype = "Grupos de edad") +
  theme_light(base_size = 12) +  
  ggtitle("Tasa de Mortalidad DM según cohorte y edad en hombres (C)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16)) +  
  guides(color = guide_legend(ncol = 7))
```

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de las cohortes de nacimiento estratificado por grupos de período

```{r}
# Colores para cada uno de los grupos de edad
coloresgg7_h <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2",
                "#7f7f7f")

# Estilos de líneas para cada uno de los grupos de edad
lineasgg7_h <- c("solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash",
                   "solid")

# Gráfico de línea
ggplot(bd_long_dm_h, 
       aes(x = factor(cohort_group), 
           y = log10(mortality_rate), 
           group = period_group, 
           color = factor(period_group), 
           linetype = factor(period_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg7_h) +  
  scale_linetype_manual(values = lineasgg7_h) +  
  labs(x = "Grupos de cohortes de nacimiento", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de período", linetype = "Grupos de período") +
  theme_light(base_size = 12) +  
  ggtitle("Tasa de Mortalidad DM según cohorte y período en hombres (D)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))
```

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de los grupos de edad estratificado por cohortes de nacimiento

```{r}
coloresgg8_h <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7", 
                "#dbdb8d", 
                "#9edae5", 
                "#ad494a", 
                "#3182bd", 
                "#e6550d", 
                "#31a354", 
                "#756bb1")

# Estilos de líneas para cada uno de los grupos de cohorte
lineasgg8_h <- c("solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid")

ggplot(bd_long_dm_h, aes(x = factor(age_group),
                       y = log10(mortality_rate), 
                       group = cohort_group, 
                       color = factor(cohort_group), 
                       linetype = factor(cohort_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg8_h) +  
  scale_linetype_manual(values = lineasgg8_h) +  
  labs(x = "Grupos de edad", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de cohorte", linetype = "Grupos de cohorte") +
  theme_light(base_size = 10) +  
  ggtitle("Tasa de Mortalidad DM según edad y cohorte en hombres (B)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16)) 
```

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de los períodos de tiempo estratificado por cohortes de nacimiento

```{r}
# Colores para cada uno de los grupos de cohorte
coloresgg9_h <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7", 
                "#dbdb8d", 
                "#9edae5", 
                "#ad494a", 
                "#3182bd", 
                "#e6550d", 
                "#31a354", 
                "#756bb1")

# Estilos de líneas para cada uno de los grupos de cohorte
lineasgg9_h <- c("solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid", 
               "dashed", 
               "dotted", 
               "dotdash", 
               "longdash", 
               "twodash", 
               "dotdash", 
               "longdash", 
               "solid")

# Gráfico de línea
ggplot(bd_long_dm_h, 
       aes(x = factor(period_group), 
           y = log10(mortality_rate), 
           group = cohort_group, 
           color = factor(cohort_group), 
           linetype = factor(cohort_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg8) +  
  scale_linetype_manual(values = lineasgg8) +  
  labs(x = "Grupos de períodos", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de cohorte", linetype = "Grupos de cohorte") +
  theme_light(base_size = 10) +  
  ggtitle("Tasa de Mortalidad DM según período y cohorte en hombres (B)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))  +  
  guides(color = guide_legend(ncol = 7))
```

## 4. Análisis descriptivo con mapa de calor

-   Mapa de calor de la tasa de mortalida de diabetes en escala logaritmica según la distribución de la tabla lexis (edad, períodos y cohortes)

```{r}
plot_APCheatmap(dat            = bd_long_dm_h,
                y_var          = "mortality_rate",
                y_var_logScale = TRUE,
                bin_heatmap    = FALSE,
                markLines_list = list(cohort = c(1898,1903,1908,1913,
                                                 1918,1923,1928,1933,
                                                 1938,1943,1948,1953,
                                                 1958,1963,1968,1973,
                                                 1978,1983,1988,1993,
                                                 1998,2003,2008,2013,
                                                 2018)))
```

## 5. Análisis descriptivo con gráfico tridimensional

-   Gráfico tridimensional sin etiquetas

```{r}
bd_long_dm_h$age_group_numeric <- as.numeric(as.factor(bd_long_dm_h$age_group))
bd_long_dm_h$period_group_numeric <- as.numeric(as.factor(bd_long_dm_h$period_group))
bd_long_dm_h$cohort_group_numeric <- as.numeric(as.factor(bd_long_dm_h$cohort_group))

bd_long_dm_h$mortality_rate_log <- log10(bd_long_dm_h$mortality_rate)

plot3D_1_h <- plot_ly(bd_long_dm_h, 
                x = ~age_group_numeric, 
                y = ~period_group_numeric, 
                z = ~cohort_group_numeric, 
                type = "scatter3d", 
                mode = "markers", 
                color = ~mortality_rate_log,
                marker = list(colorscale = "Viridis", 
                              cmin = min(bd_long_dm_h$mortality_rate_log), 
                              cmax = max(bd_long_dm_h$mortality_rate_log),  
                              colorbar = list(title = "log10 Mortality Rate"))) %>%
  layout(scene = list(xaxis = list(title = 'Age Group'),
                      yaxis = list(title = 'Period Group'),
                      zaxis = list(title = 'Cohort Group'),
                      aspectmode = "cube"), 
         title = "Gráfico 3D Mortalidad de diabetes mellitus por Grupos de Edad, Periodo y Cohorte en hombres")

plot3D_1_h
```

-   Gráfico tridimensional con etiquetas

```{r}
age_group_labels_h <- c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", 
                      "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", 
                      "60-64", "65-69", "70-74", "75-79", "80-84", "85+")

period_group_labels_h <- c("1983-1987", "1988-1992", "1993-1997", 
                         "1998-2002", "2003-2007", "2008-2012", 
                         "2013-2017", "2018-2022")

cohort_group_labels_h <- c("1898-1902", "1903-1907", "1908-1912", 
                         "1913-1917", "1918-1922", "1923-1927", 
                         "1928-1932", "1933-1937", "1938-1942", 
                         "1943-1947", "1948-1952", "1953-1957", 
                         "1958-1962", "1963-1967", "1968-1972", 
                         "1973-1977", "1978-1982", "1983-1987", 
                         "1988-1992", "1993-1997", "1998-2002", 
                         "2003-2007", "2008-2012", "2013-2017", 
                         "2018-2022")

plot3D_2_h <- plot_ly(bd_long_dm_h, 
                x = ~age_group_numeric, 
                y = ~period_group_numeric, 
                z = ~cohort_group_numeric, 
                type = "scatter3d", 
                mode = "markers", 
                color = ~mortality_rate_log,
                marker = list(colorscale = "Viridis", 
                              cmin = min(bd_long_dm_h$mortality_rate_log), 
                              cmax = max(bd_long_dm_h$mortality_rate_log),  
                              colorbar = list(title = "log10 Mortality Rate"))) %>%
  layout(scene = list(xaxis = list(title = 'Age Group', tickvals = 1:length(age_group_labels_h), ticktext = age_group_labels_h),
                      yaxis = list(title = 'Period Group', tickvals = 1:length(period_group_labels_h), ticktext = period_group_labels_h),
                      zaxis = list(title = 'Cohort Group', tickvals = 1:length(cohort_group_labels_h), ticktext = cohort_group_labels_h),
                      aspectmode = "cube"),
         title = "Gráfico 3D Mortalidad de diabetes mellitus por Grupos de Edad, Periodo y Cohorte en hombres")

plot3D_2_h
```

## 6. Modelos de regresión de quasi-poisson simples

-   Organizar las bases de datos de tabla de Lexis en formato edad\*periodo con las respectivas etiquetas

```{r, warning=FALSE}
bd_lexis_f_dm_a_p_h <- apcheader(r=bd_lexis_f_dm_h, 
                               agestart=0, 
                               yearstart=1983, 
                               agespan=5, 
                               yearspan=5, 
                               head=F)
```

```{r, warning=FALSE}
bd_lexis_p_dm_a_p_h <- apcheader(r=bd_lexis_p_dm_h, 
                               agestart=0, 
                               yearstart=1983, 
                               agespan=5, 
                               yearspan=5, 
                               head=F)
```

```{r, warning=FALSE}
bd_lexis_t_dm_a_p_h <- apcheader(r=bd_lexis_t_dm_h, 
                               agestart=0, 
                               yearstart=1983, 
                               agespan=5, 
                               yearspan=5, 
                               head=F)
```

**Modelo simple del efecto de la edad, como variable independiente, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_A_h <- apcglmfit(r=bd_lexis_t_dm_a_p_h, header=T, n.risk= bd_lexis_p_dm_a_p_h, Scale=1e-5, apcmodel="A", fam="qlik", Plot=T)
model_A_h
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_A_h)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_A_h <- model_A_h$parameter[, "Estimate"]
std_errors_model_A_h <- model_A_h$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_A_h <- parameters_model_A_h - 1.96 * std_errors_model_A_h
conf_int_upper_model_A_h <- parameters_model_A_h + 1.96 * std_errors_model_A_h

# Mostrar los intervalos de confianza
conf_int_model_A_h <- data.frame(lower = conf_int_lower_model_A_h, upper = conf_int_upper_model_A_h)
conf_int_model_A_h
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_A_h <- exp(model_A_h$parameter[, "Estimate"])
coef_exp_model_A_h <- round(coef_exp_model_A_h, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_A_h <- exp(model_A_h$parameter[, "Estimate"] - 1.96 * model_A_h$parameter[, "Std. Error"])
conf_int_lower_exp_model_A_h <- round(conf_int_lower_exp_model_A_h, 2)

conf_int_upper_exp_model_A_h <- exp(model_A_h$parameter[, "Estimate"] + 1.96 * model_A_h$parameter[, "Std. Error"])
conf_int_upper_exp_model_A_h <- round(conf_int_upper_exp_model_A_h, 2)


# Crear un data frame con los resultados exponenciados
results_exp_model_A_h <- data.frame(Rate_Ratio = coef_exp_model_A_h,
                          lower = conf_int_lower_exp_model_A_h,
                          upper = conf_int_upper_exp_model_A_h)

# Mostrar los resultados
results_exp_model_A_h
```

**Modelo simple del efecto del período, como variable independiente, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_P_h <- apcglmfit(r=bd_lexis_t_dm_a_p_h, header=T, n.risk= bd_lexis_p_dm_a_p_h, Scale=1e-5, apcmodel="P", fam="qlik", Plot=T)
model_P_h
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_P_h)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_P_h <- model_P_h$parameter[, "Estimate"]
std_errors_model_P_h <- model_P_h$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_P_h <- parameters_model_P_h - 1.96 * std_errors_model_P_h
conf_int_upper_model_P_h <- parameters_model_P_h + 1.96 * std_errors_model_P_h

# Mostrar los intervalos de confianza
conf_int_model_P_h <- data.frame(lower = conf_int_lower_model_P_h, upper = conf_int_upper_model_P_h)
conf_int_model_P_h
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_P_h <- exp(model_P_h$parameter[, "Estimate"])
coef_exp_model_P_h <- round(coef_exp_model_P_h, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_P_h <- exp(model_P_h$parameter[, "Estimate"] - 1.96 * model_P_h$parameter[, "Std. Error"])
conf_int_lower_exp_model_P_h <- round(conf_int_lower_exp_model_P_h, 2)

conf_int_upper_exp_model_P_h <- exp(model_P_h$parameter[, "Estimate"] + 1.96 * model_P_h$parameter[, "Std. Error"])
conf_int_upper_exp_model_P_h <- round(conf_int_upper_exp_model_P_h, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_P_h <- data.frame(Rate_Ratio = coef_exp_model_P_h,
                          lower = conf_int_lower_exp_model_P_h,
                          upper = conf_int_upper_exp_model_P_h)

# Mostrar los resultados
results_exp_model_P_h
```

**Modelo simple del efecto de la cohorte, como variable independiente, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_C_h <- apcglmfit(r=bd_lexis_t_dm_a_p_h, header=T, n.risk= bd_lexis_p_dm_a_p_h, Scale=1e-5, apcmodel="C", fam="qlik", Plot=T)
model_C_h
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_C_h)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_C_h <- model_C_h$parameter[, "Estimate"]
std_errors_model_C_h <- model_C_h$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_C_h <- parameters_model_C_h - 1.96 * std_errors_model_C_h
conf_int_upper_model_C_h <- parameters_model_C_h + 1.96 * std_errors_model_C_h

# Mostrar los intervalos de confianza
conf_int_model_C_h <- data.frame(lower = conf_int_lower_model_C_h, upper = conf_int_upper_model_C_h)
conf_int_model_C_h
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_C_h <- exp(model_C_h$parameter[, "Estimate"])
coef_exp_model_C_h <- round(coef_exp_model_C_h, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_C_h <- exp(model_C_h$parameter[, "Estimate"] - 1.96 * model_C_h$parameter[, "Std. Error"])
conf_int_lower_exp_model_C_h <- round(conf_int_lower_exp_model_C_h, 2)

conf_int_upper_exp_model_C_h <- exp(model_C_h$parameter[, "Estimate"] + 1.96 * model_C_h$parameter[, "Std. Error"])
conf_int_upper_exp_model_C_h <- round(conf_int_upper_exp_model_C_h, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_C_h <- data.frame(Rate_Ratio = coef_exp_model_C_h,
                          lower = conf_int_lower_exp_model_C_h,
                          upper = conf_int_upper_exp_model_C_h)

# Mostrar los resultados
results_exp_model_C_h
```

-   Medidas de bondad de ajuste de los modelos de regresión quasi-poisson simples

| Modelo  | Deviance | Grados de libertad | Parámetro de dispersión |
|---------|----------|--------------------|-------------------------|
| Edad    | 5290,903 | 126                | 39,44733                |
| Periodo | 341292,6 | 136                | 5927,161                |
| Cohorte | 78371,37 | 119                | 712,1813                |

## 7. Modelos de regresión de quasi-poisson múltiples:

**Modelo múltiple del efecto de la edad y el período, como variables independientes, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_AP_h <- apcglmfit(r=bd_lexis_t_dm_a_p_h, header=T, n.risk= bd_lexis_p_dm_a_p_h, Scale=1e-5, apcmodel="AP", fam="qlik", Plot=T)
model_AP_h
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_AP_h)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_AP_h <- model_AP_h$parameter[, "Estimate"]
std_errors_model_AP_h <- model_AP_h$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_AP_h <- parameters_model_AP_h - 1.96 * std_errors_model_AP_h
conf_int_upper_model_AP_h <- parameters_model_AP_h + 1.96 * std_errors_model_AP_h

# Mostrar los intervalos de confianza
conf_int_model_AP_h <- data.frame(lower = conf_int_lower_model_AP_h, upper = conf_int_upper_model_AP_h)
conf_int_model_AP_h
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_AP_h <- exp(model_AP_h$parameter[, "Estimate"])

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_AP_h <- exp(model_AP_h$parameter[, "Estimate"] - 1.96 * model_AP_h$parameter[, "Std. Error"])
conf_int_upper_exp_model_AP_h <- exp(model_AP_h$parameter[, "Estimate"] + 1.96 * model_AP_h$parameter[, "Std. Error"])

# Crear un data frame con los resultados exponenciados
results_exp_model_AP_h <- data.frame(Rate_Ratio = coef_exp_model_AP_h,
                          lower = conf_int_lower_exp_model_AP_h,
                          upper = conf_int_upper_exp_model_AP_h)

# Mostrar los resultados
results_exp_model_AP_h
```

**Modelo múltiple del efecto de la edad y la cohorte, como variables independientes, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_AC_h <- apcglmfit(r=bd_lexis_t_dm_a_p_h, header=T, n.risk= bd_lexis_p_dm_a_p_h, Scale=1e-5, apcmodel="AC", fam="qlik", Plot=T)
model_AC_h
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_AC_h)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_AC_h <- model_AC_h$parameter[, "Estimate"]
std_errors_model_AC_h <- model_AC_h$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_AC_h <- parameters_model_AC_h - 1.96 * std_errors_model_AC_h
conf_int_upper_model_AC_h <- parameters_model_AC_h + 1.96 * std_errors_model_AC_h

# Mostrar los intervalos de confianza
conf_int_model_AC_h <- data.frame(lower = conf_int_lower_model_AC_h, upper = conf_int_upper_model_AC_h)
conf_int_model_AC_h
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_AC_h <- exp(model_AC_h$parameter[, "Estimate"])

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_AC_h <- exp(model_AC_h$parameter[, "Estimate"] - 1.96 * model_AC_h$parameter[, "Std. Error"])
conf_int_upper_exp_model_AC_h <- exp(model_AC_h$parameter[, "Estimate"] + 1.96 * model_AC_h$parameter[, "Std. Error"])

# Crear un data frame con los resultados exponenciados
results_exp_model_AC_h <- data.frame(Rate_Ratio = coef_exp_model_AC_h,
                          lower = conf_int_lower_exp_model_AC_h,
                          upper = conf_int_upper_exp_model_AC_h)

# Mostrar los resultados
results_exp_model_AC_h
```

-   Medidas de bondad de ajuste de los modelos de regresión quasi-poisson simples y múltiples

+--------------+--------------+--------------------+-------------------------+
| Modelo       | Deviance     | Grados de libertad | Parámetro de dispersión |
+==============+==============+====================+=========================+
| Edad         | 5290,903     | 126                | 39,44733                |
+--------------+--------------+--------------------+-------------------------+
| Período      | 341292,6     | 136                | 5927,161                |
+--------------+--------------+--------------------+-------------------------+
| Cohorte      | 78371,37     | 119                | 712,1813                |
+--------------+--------------+--------------------+-------------------------+
| Edad-Período | 1810,964     | 119                | 14,97281                |
+--------------+--------------+--------------------+-------------------------+
| Edad-Cohorte | 2375,778     | 102                | 23,74798                |
+--------------+--------------+--------------------+-------------------------+

## **8. Modelo de regresión de quasi-poisson multiple completo y gráficos de los efectos ajustados:**

**Modelo múltiple del efecto de la edad, el período y la cohorte, como variables independientes, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_APC_h <- apcglmfit(r=bd_lexis_t_dm_a_p_h, header=T, n.risk= bd_lexis_p_dm_a_p_h, Scale=1e-5, apcmodel="APC", fam="qlik", Plot=T)
model_APC_h
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_APC_h)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_APC_h <- model_APC_h$parameter[, "Estimate"]
std_errors_model_APC_h <- model_APC_h$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_APC_h <- parameters_model_APC_h - 1.96 * std_errors_model_APC_h
conf_int_upper_model_APC_h <- parameters_model_APC_h + 1.96 * std_errors_model_APC_h

# Mostrar los intervalos de confianza
conf_int_model_APC_h <- data.frame(lower = conf_int_lower_model_APC_h, upper = conf_int_upper_model_APC_h)
conf_int_model_APC_h
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_APC_h <- exp(model_APC_h$parameter[, "Estimate"])
coef_exp_model_APC_h <- round(coef_exp_model_APC_h, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_APC_h <- exp(model_APC_h$parameter[, "Estimate"] - 1.96 * model_APC_h$parameter[, "Std. Error"])
conf_int_lower_exp_model_APC_h <- round(conf_int_lower_exp_model_APC_h, 2)

conf_int_upper_exp_model_APC_h <- exp(model_APC_h$parameter[, "Estimate"] + 1.96 * model_APC_h$parameter[, "Std. Error"])
conf_int_upper_exp_model_APC_h <- round(conf_int_upper_exp_model_APC_h, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_APC_h <- data.frame(Rate_Ratio = coef_exp_model_APC_h,
                          lower = conf_int_lower_exp_model_APC_h,
                          upper = conf_int_upper_exp_model_APC_h)

# Mostrar los resultados
results_exp_model_APC_h
```

-   *Gráfico efectos de la edad*

```{r}
edad_hombres <- readxl::read_excel("resultados_modelo_hombres_edad.xlsx")

edad_hombres$grupo <- edad_hombres$grupo |> 
  replace_na() |> 
  factor(ordered = T, levels = c(
    "0-4", "5-9", "10-14", "15-19", "20-24", "25-29", 
    "30-34", "35-39", "40-44", "45-49", 
    "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+") )
edad_hombres

ggplot(edad_hombres, aes(x=grupo, y=estimador, group = 1)) +
  geom_ribbon(aes(ymin=ic_liminf, ymax=ic_limsup), fill = "lightblue", alpha = 0.5) +
  geom_point(color="blue", size = 3) +
  geom_line(color = "blue", size = 1, linetype = "dashed") +
  labs(x="Grupo de edad", y="Coeficiente de regresión", 
       title="Efectos de la edad en la mortalidad por DM en hombres (A)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 16),
        legend.position = "none")
```

-   *Gráfico efectos del período*

```{r}
periodo_hombres <- readxl::read_excel("resultados_modelo_hombres_periodo.xlsx")

periodo_hombres$grupo <- periodo_hombres$grupo |> 
  replace_na() |> 
  factor(ordered = T, levels = c(
    "1983-1987", "1988-1992", "1993-1997", 
    "1998-2002", "2003-2007", "2008-2012", 
    "2013-2017", "2018-2022") )
periodo_hombres

ggplot(periodo_hombres, aes(x=grupo, y=estimador, group = 1)) +
  geom_ribbon(aes(ymin=ic_liminf, ymax=ic_limsup), fill = "salmon", alpha = 0.5) +
  geom_point(color="red", size = 3) +
  geom_line(color = "red", size = 1, linetype = "dashed") +
  labs(x="Grupo de periodo", y="Coeficiente de regresión", 
       title="Efectos del periodo en la mortalidad por DM en hombres (B)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 16),
        legend.position = "none")
```

-   *Gráfico efectos de la cohorte*

```{r}
cohorte_hombres <- readxl::read_excel("resultados_modelo_hombres_cohorte.xlsx")

cohorte_hombres$grupo <- cohorte_hombres$grupo |> 
  replace_na() |> 
  factor(ordered = T, levels = c(
    "1898-1902", "1903-1907", "1908-1912", 
    "1913-1917", "1918-1922",
    "1923-1927", "1928-1932", "1933-1937",
    "1938-1942", "1943-1947",
    "1948-1952", "1953-1957", "1958-1962", 
    "1963-1967", "1968-1972",
    "1973-1977", "1978-1982", "1983-1987", 
    "1988-1992", "1993-1997",
    "1998-2002", "2003-2007", "2008-2012", 
    "2013-2017", "2018-2022") )
cohorte_hombres

ggplot(cohorte_hombres, aes(x=grupo, y=estimador, group = 1)) +
  geom_ribbon(aes(ymin=ic_liminf, ymax=ic_limsup), fill = "lightgreen", alpha = 0.5) +
  geom_point(color="green", size = 3) +
  geom_line(color = "green", size = 1, linetype = "dashed") +
  labs(x="Grupo de cohorte", y="Coeficiente de regresión", 
       title="Efectos de la cohorte en la mortalidad por DM en hombres (C)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 16),
        legend.position = "none")
```

-   Medidas de bondad de ajuste de los modelos de regresión quasi-poisson simples y múltiples

+----------------------+--------------+--------------------+-------------------------+
| Modelo               | Deviance     | Grados de libertad | Parámetro de dispersión |
+======================+==============+====================+=========================+
| Edad                 | 5290,903     | 126                | 39,44733                |
+----------------------+--------------+--------------------+-------------------------+
| Período              | 341292,6     | 136                | 5927,161                |
+----------------------+--------------+--------------------+-------------------------+
| Cohorte              | 78371,37     | 119                | 712,1813                |
+----------------------+--------------+--------------------+-------------------------+
| Edad-Período         | 1810,964c    | 119                | 14,97281                |
+----------------------+--------------+--------------------+-------------------------+
| Edad-Cohorte         | 2375,778     | 102                | 23,74798                |
+----------------------+--------------+--------------------+-------------------------+
| Edad-Período-Cohorte | 327,389      | 96                 | 3,399767                |
+----------------------+--------------+--------------------+-------------------------+

# Análisis según sexo femenino

## 1. Análisis descriptivo univariado

**Variable dependiente:**

Conteo de fallecimientos por diabetes mellitus

-   Medidas de resumen:

```{r}
descr(bd_long_dm_m$deaths)
```

-   Gráfico de densidad:

```{r}
ggplot(bd_long_dm_m,         
       mapping = aes(x = deaths, fill = "Density")) +   
  geom_density(alpha = 0.7, 
               color = "darkblue", 
               fill = "darkblue") +   
  labs(x = "Conteo fallecimientos", y = "Densidad") +   
  ggtitle("Gráfico de densidad del conteo de fallecimientos por diabetes mellitus según sexo femenino")
```

-   Gráfico boxplot:

```{r,warning=FALSE}
ggplot(bd_long_dm_m, 
       aes(x = deaths)) +   
  geom_boxplot(color = "darkblue", alpha = 0.5) +   
  ggtitle("Boxplot del conteo de fallecimientos por diabetes mellitus según sexo femenino")
```

Tasa de mortalidad de diabetes mellitus por cada 100.000 personas

-   Medidas de resumen:

```{r}
descr(bd_long_dm_m$mortality_rate)
```

-   Gráfico de densidad:

```{r,warning=FALSE}
ggplot(bd_long_dm_m,         
       aes(x = mortality_rate, 
           fill = "Density")) +   
  geom_density(alpha = 0.7, 
               color = "darkblue", 
               fill = "darkblue") +   
  labs(x = "Tasa cruda de mortalidad", y = "Densidad") +   
  ggtitle("Gráfico de densidad tasa cruda de mortalidad por diabetes mellitus según sexo femenino")
```

-   Gráfico boxplot:

```{r,warning=FALSE}
ggplot(bd_long_dm_m, 
       aes(x = mortality_rate)) +   
  geom_boxplot(color = "darkblue", 
               alpha = 0.5) +   
  ggtitle("Boxplot tasa cruda de mortalidad por diabetes mellitus según sexo femenino")
```

## 2. Análisis descriptivo bivariado

**Variable dependiente en función de los grupos de edad, grupos de período y grupos de cohorte de nacimiento:**

-   Conteo de fallecimientos por diabetes mellitus según grupos de edad

```{r}
bd_long_dm_m %>%   
  group_by(age_group) %>%   
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Frecuencia_Porcentual = round(sum(deaths) / sum(bd_long_dm_m$deaths) * 100, 2)
  ) %>%
  bind_rows(
    summarise(., 
              age_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos),   
              Frecuencia_Porcentual = round(sum(Frecuencia_Porcentual), 2))
  ) %>%
  knitr::kable()
```

-   Conteo de fallecimientos por diabetes mellitus según grupos de período

```{r}
bd_long_dm_m %>%   
  group_by(period_group) %>%   
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Frecuencia_Porcentual = round(sum(deaths) / sum(bd_long_dm_m$deaths) * 100, 2)
  ) %>%
  bind_rows(
    summarise(., 
              period_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos),     
              Frecuencia_Porcentual = round(sum(Frecuencia_Porcentual), 2))
  ) %>%
  knitr::kable()
```

-   Conteo de fallecimientos por diabetes mellitus según grupos de cohorte de nacimiento

```{r}
bd_long_dm_m %>%   
  group_by(cohort_group) %>%
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Frecuencia_Porcentual = round(sum(deaths) / sum(bd_long_dm_m$deaths) * 100, 2)
  ) %>%
  bind_rows(
    summarise(., 
              cohort_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos),
              Frecuencia_Porcentual = round(sum(Frecuencia_Porcentual), 2))
  ) %>%
  knitr::kable()
```

-   Tasa cruda de mortalidad por diabetes mellitus según grupos de edad

```{r}
bd_long_dm_m %>% 
  group_by(age_group) %>%   
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Poblacion = sum(population),
    Tasa_especifica = round((sum(deaths) / sum(population)) * 100000, 2)
  ) %>% 
  bind_rows(
    summarise(., 
              age_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Poblacion = sum(Poblacion),               
              Tasa_especifica = round((sum(Conteo_fallecimientos) / sum(Poblacion)) * 100000, 2))
  ) %>%   
  knitr::kable()
```

-   Tasa cruda de mortalidad por diabetes mellitus según grupos de período

```{r}
bd_long_dm_m %>% 
  group_by(period_group) %>%   
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Poblacion = sum(population),
    Tasa_especifica = round((sum(deaths) / sum(population)) * 100000, 2)
  ) %>%
  bind_rows(
    summarise(., 
              period_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos), 
              Poblacion = sum(Poblacion),
              Tasa_especifica = round((sum(Conteo_fallecimientos) / sum(Poblacion)) * 100000, 2))
  ) %>%   
  knitr::kable()
```

-   Tasa cruda de mortalidad por diabetes mellitus según grupos de cohorte

```{r}
bd_long_dm_m %>%
  group_by(cohort_group) %>%
  summarise(
    Conteo_fallecimientos = sum(deaths),
    Poblacion = sum(population),
    Tasa_especifica = round((sum(deaths) / sum(population)) * 100000, 2)
  ) %>%
  bind_rows(
    summarise(., 
              cohort_group = "Total",
              Conteo_fallecimientos = sum(Conteo_fallecimientos),
              Poblacion = sum(Poblacion),
              Tasa_especifica = round((sum(Conteo_fallecimientos) / sum(Poblacion)) * 100000, 2))
  ) %>%
  knitr::kable()
```

**Variable dependiente en función de la edad, el período y la cohorte (Gráficos unidimensionales):**

-   Gráfico boxplot en escala logaritmica para la tasa de mortalidad de diabetes según edad

```{r,message=FALSE,warning=FALSE}
#Colores para el gráfico 
coloresgg1_m <- c("#1f77b4",                  
                "#ff7f0e",                  
                "#2ca02c",                  
                "#d62728",                  
                "#9467bd",                  
                "#8c564b",                  
                "#e377c2",                  
                "#7f7f7f",                  
                "#bcbd22",                  
                "#17becf",                  
                "#aec7e8",                  
                "#ffbb78",                  
                "#98df8a",                  
                "#ff9896",                  
                "#c5b0d5",                  
                "#c49c94",                  
                "#f7b6d2",                  
                "#c7c7c7")  

# Especificar orden de los grupos de edad 
bd_long_dm_m$age_group <- factor(bd_long_dm_m$age_group,
                               levels = c("0-4", "5-9", "10-14",
                                          "15-19", "20-24", "25-29",
                                          "30-34", "35-39", "40-44",
                                          "45-49", "50-54", "55-59",
                                          "60-64", "65-69", "70-74",
                                          "75-79", "80-84", "85+"))  

# Grafico boxplot 
ggplot(bd_long_dm_m, 
       aes(x = age_group,                         
           y = log10(mortality_rate),                         
           fill = age_group)) +    
  geom_boxplot() +    
  scale_fill_manual(values = coloresgg1_m) +    
  labs(x = "Grupos de edad",         
       y = "Tasa de Mortalidad de DM*100.000 (log10)",         
       fill = "Grupos de edad") +   
  ggtitle("Tasa de mortalidad por DM según grupos de edad en mujeres (A)") +    
  theme_minimal() +    
  theme(axis.text.x = element_text(color = "black", angle = 45, size = 18), 
        axis.text.y = element_text(color = "black", size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18))
```

-   Gráfico boxplot en escala logaritmica para la tasa de mortalidad de diabetes según períodos

```{r,message=FALSE,warning=FALSE}
#Colores para el gráfico 
coloresgg2_m <- c("#1f77b4",                  
                "#ff7f0e",                  
                "#2ca02c",                  
                "#d62728",                  
                "#9467bd",                  
                "#8c564b",                  
                "#e377c2",                  
                "#7f7f7f")  

# Especificar orden de los grupos de período 
bd_long_dm_m$period_group <- factor(bd_long_dm_m$period_group,
                                  levels = c("1983-1987", "1988-1992", "1993-1997",
                                             "1998-2002", "2003-2007", "2008-2012",                                               "2013-2017", "2018-2022"))  

# Grafico boxplot 
ggplot(bd_long_dm_m, 
       aes(x = period_group,                         
           y = log10(mortality_rate),                         
           fill = period_group)) +   
  geom_boxplot() +   
  scale_fill_manual(values = coloresgg2_m) +   
  labs(x = "Grupos de período",         
       y = "Tasa de Mortalidad de DM*100.000 (log10)",         
       fill = "Grupos de Período") +   
  ggtitle("Tasa de mortalidad por DM según grupos de período en mujeres (B)") +   
  theme_minimal() +    
  theme(axis.text.x = element_text(color = "black", angle = 45, size = 18),
        axis.text.y = element_text(color = "black", size = 18),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18))
```

-   Gráfico boxplot en escala logaritmica para la tasa de mortalidad de diabetes según cohortes

```{r}
# Colores para el gráfico 
coloresgg3_m <- c("#1f77b4",                  
                "#ff7f0e",                  
                "#2ca02c",                  
                "#d62728",                  
                "#9467bd",                  
                "#8c564b",                  
                "#e377c2",                  
                "#7f7f7f",                 
                "#bcbd22",                 
                "#17becf",                 
                "#aec7e8",                 
                "#ffbb78",                 
                "#98df8a",                 
                "#ff9896",                 
                "#c5b0d5",                 
                "#c49c94",                 
                "#f7b6d2",                 
                "#c7c7c7",                 
                "#dbdb8d",                 
                "#9edae5",                 
                "#ad494a",                 
                "#8c6d31",                 
                "#e7ba52",                 
                "#9467bd",                 
                "#d6616b")  

# Especificar orden de los grupos de cohortes 
bd_long_dm_m$cohort_group <- factor(bd_long_dm_m$cohort_group,
                                  levels = c("1898-1902", "1903-1907", "1908-1912",                                               "1913-1917", "1918-1922","1923-1927",
                                             "1928-1932", "1933-1937","1938-1942", 
                                             "1943-1947","1948-1952", "1953-1957", 
                                             "1958-1962","1963-1967", "1968-1972",                                              "1973-1977", "1978-1982", "1983-1987",                                               "1988-1992", "1993-1997","1998-2002",
                                             "2003-2007", "2008-2012","2013-2017", 
                                             "2018-2022"))  

# Grafico boxplot 
ggplot(bd_long_dm_m, 
       aes(x = cohort_group,                         
           y = log10(mortality_rate),                         
           fill = cohort_group)) +   
  geom_boxplot() +   
  scale_fill_manual(values = coloresgg3_m) +   
  labs(x = "Grupos de Cohortes de nacimiento",         
       y = "Tasa de Mortalidad de DM*100.000 (log10)",        
       fill = "Grupos de Cohortes") +   
  ggtitle("Tasa de mortalidad por DM según grupos de cohorte en mujeres (C)") +   
  theme_minimal() +   
  theme(axis.text.x = element_text(color = "black", angle = 45, size = 13),
        axis.text.y = element_text(color = "black", size = 18),
        legend.position = "top",
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 18),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18))
```

## 3. Análisis descriptivo con gráficos bidimensionales

**Variable dependiente en función de la edad, el período y la cohorte:**

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de la edad estratificado por periodos

```{r}
# Colores para cada uno de los grupos de período
coloresgg4_m <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf")

# Estilos de líneas para cada uno de los grupos de périodo
lineasgg4_m <- c("solid", 
            "dashed", 
            "dotted", 
            "dotdash", 
            "longdash", 
            "twodash", 
            "dotdash", 
            "longdash", 
            "dashed", 
            "dotted")

# Gráfico de línea
ggplot(bd_long_dm_m, 
       aes(x = factor(age_group), 
           y = log10(mortality_rate), 
           group = period_group, 
           color = factor(period_group), 
           linetype = factor(period_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg4_m) +  
  scale_linetype_manual(values = lineasgg4_m) +  
  labs(x = "Grupos de edad", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de período", linetype = "Grupos de período (A)") +
  theme_light(base_size = 12) +  
  ggtitle("Tasa de Mortalidad DM según edad y período en mujeres") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16)) 
```

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de los períodos estratificado por grupos de edad

```{r}
# Colores para cada uno de los grupos de edad
coloresgg5_m <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7")

# Estilos de líneas para cada uno de los grupos de edad
lineasgg5_m <- c("solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed")

# Gráfico de línea
ggplot(bd_long_dm_m, 
       aes(x = factor(period_group), 
           y = log10(mortality_rate), 
           group = age_group, 
           color = factor(age_group), 
           linetype = factor(age_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg5_m) +  
  scale_linetype_manual(values = lineasgg5_m) +  
  labs(x = "Grupos de período", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de edad", linetype = "Grupos de edad") +
  theme_light(base_size = 12) +  
  ggtitle("Tasa de Mortalidad DM según período y edad en mujeres (B)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))  +  
  guides(color = guide_legend(ncol = 6))
```

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de las cohortes de nacimiento estratificado por grupos de edad

```{r}
# Colores para cada uno de los grupos de edad
coloresgg6_m <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2", 
                "#7f7f7f", 
                "#bcbd22", 
                "#17becf", 
                "#aec7e8", 
                "#ffbb78", 
                "#98df8a", 
                "#ff9896", 
                "#c5b0d5", 
                "#c49c94", 
                "#f7b6d2", 
                "#c7c7c7")

# Estilos de líneas para cada uno de los grupos de edad
lineasgg6_m <- c("solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash", 
                   "solid", 
                   "dashed")

# Gráfico de línea
ggplot(bd_long_dm_m, 
       aes(x = factor(cohort_group), 
           y = log10(mortality_rate), 
           group = age_group, 
           color = factor(age_group), 
           linetype = factor(age_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg6_m) +  
  scale_linetype_manual(values = lineasgg6_m) +  
  labs(x = "Grupos de cohortes de nacimiento", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de edad", linetype = "Grupos de edad") +
  theme_light(base_size = 12) +  
  ggtitle("Tasa de Mortalidad DM según cohorte y edad en mujeres (C)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16)) +  
  guides(color = guide_legend(ncol = 7))
```

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de las cohortes de nacimiento estratificado por grupos de período

```{r}
# Colores para cada uno de los grupos de edad
coloresgg7_m <- c("#1f77b4", 
                "#ff7f0e", 
                "#2ca02c", 
                "#d62728", 
                "#9467bd", 
                "#8c564b", 
                "#e377c2",
                "#7f7f7f")

# Estilos de líneas para cada uno de los grupos de edad
lineasgg7_m <- c("solid", 
                   "dashed", 
                   "dotted", 
                   "dotdash", 
                   "longdash", 
                   "twodash", 
                   "dotdash", 
                   "longdash",
                   "solid")

# Gráfico de línea
ggplot(bd_long_dm_m, 
       aes(x = factor(cohort_group), 
           y = log10(mortality_rate), 
           group = period_group, 
           color = factor(period_group), 
           linetype = factor(period_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg7_m) +  
  scale_linetype_manual(values = lineasgg7_m) +  
  labs(x = "Grupos de cohortes de nacimiento", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de período", linetype = "Grupos de período") +
  theme_light(base_size = 12) +  
  ggtitle("Tasa de Mortalidad DM según cohorte y período en mujeres (D)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))
```

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de los grupos de edad estratificado por cohortes de nacimiento

```{r}
coloresgg8_m <- c("#1f77b4", 
                  "#ff7f0e", 
                  "#2ca02c", 
                  "#d62728", 
                  "#9467bd", 
                  "#8c564b", 
                  "#e377c2", 
                  "#7f7f7f", 
                  "#bcbd22", 
                  "#17becf", 
                  "#aec7e8", 
                  "#ffbb78", 
                  "#98df8a", 
                  "#ff9896", 
                  "#c5b0d5", 
                  "#c49c94", 
                  "#f7b6d2", 
                  "#c7c7c7", 
                  "#dbdb8d", 
                  "#9edae5", 
                  "#ad494a", 
                  "#3182bd", 
                  "#e6550d", 
                  "#31a354", 
                  "#756bb1")

# Estilos de líneas para cada uno de los grupos de cohorte
lineasgg8_m <- c("solid", 
                 "dashed", 
                 "dotted", 
                 "dotdash", 
                 "longdash", 
                 "twodash", 
                 "dotdash", 
                 "longdash", 
                 "solid", 
                 "dashed", 
                 "dotted", 
                 "dotdash", 
                 "longdash", 
                 "twodash", 
                 "dotdash", 
                 "longdash", 
                 "solid", 
                 "dashed", 
                 "dotted", 
                 "dotdash", 
                 "longdash", 
                 "twodash", 
                 "dotdash", 
                 "longdash", 
                 "solid")

ggplot(bd_long_dm_m, aes(x = factor(age_group),
                         y = log10(mortality_rate), 
                         group = cohort_group, 
                         color = factor(cohort_group), 
                         linetype = factor(cohort_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg8_m) +  
  scale_linetype_manual(values = lineasgg8_m) +  
  labs(x = "Grupos de edad", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de cohorte", linetype = "Grupos de cohorte") +
  theme_light(base_size = 10) +  
  ggtitle("Tasa de Mortalidad DM según edad y cohorte en mujeres (C)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16)) 
```

-   Gráfico de lineas en escala logaritmica de la tasa de mortalidad de diabetes en función de los períodos de tiempo estratificado por cohortes de nacimiento

```{r}
# Colores para cada uno de los grupos de cohorte
coloresgg9_m <- c("#1f77b4", 
                  "#ff7f0e", 
                  "#2ca02c", 
                  "#d62728", 
                  "#9467bd", 
                  "#8c564b", 
                  "#e377c2", 
                  "#7f7f7f", 
                  "#bcbd22", 
                  "#17becf", 
                  "#aec7e8", 
                  "#ffbb78", 
                  "#98df8a", 
                  "#ff9896", 
                  "#c5b0d5", 
                  "#c49c94", 
                  "#f7b6d2", 
                  "#c7c7c7", 
                  "#dbdb8d", 
                  "#9edae5", 
                  "#ad494a", 
                  "#3182bd", 
                  "#e6550d", 
                  "#31a354", 
                  "#756bb1")

# Estilos de líneas para cada uno de los grupos de cohorte
lineasgg9_m <- c("solid", 
                 "dashed", 
                 "dotted", 
                 "dotdash", 
                 "longdash", 
                 "twodash", 
                 "dotdash", 
                 "longdash", 
                 "solid", 
                 "dashed", 
                 "dotted", 
                 "dotdash", 
                 "longdash", 
                 "twodash", 
                 "dotdash", 
                 "longdash", 
                 "solid", 
                 "dashed", 
                 "dotted", 
                 "dotdash", 
                 "longdash", 
                 "twodash", 
                 "dotdash", 
                 "longdash", 
                 "solid")

# Gráfico de línea
ggplot(bd_long_dm_m, 
       aes(x = factor(period_group), 
           y = log10(mortality_rate), 
           group = cohort_group, 
           color = factor(cohort_group), 
           linetype = factor(cohort_group))) +
  geom_line(linewidth = 1.0) +  
  scale_color_manual(values = coloresgg8) +  
  scale_linetype_manual(values = lineasgg8) +  
  labs(x = "Grupos de períodos", 
       y = "Tasa*100.000(log10)", 
       color = "Grupos de cohorte", linetype = "Grupos de cohorte") +
  theme_light(base_size = 10) +  
  ggtitle("Tasa de Mortalidad DM según período y cohorte en mujeres (C)") +
  theme(legend.position = "top",  
        legend.text = element_text(size = 14),  
        legend.key.size = unit(0.5, "cm"),   
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),  
        axis.text.x = element_text(color = "black", angle = 45, size = 14),  
        axis.text.y = element_text(color = "black", size = 16),  
        axis.title = element_text(size = 16),  
        plot.title = element_text(size = 16),  
        axis.text = element_text(size = 16),
        legend.title = element_text(size = 16))  +  
  guides(color = guide_legend(ncol = 7))
```

## 4. Análisis descriptivo con mapa de calor

-   Mapa de calor de la tasa de mortalida de diabetes en escala logaritmica según la distribución de la tabla lexis (edad, períodos y cohortes)

```{r}
plot_APCheatmap(dat            = bd_long_dm_m,
                y_var          = "mortality_rate",
                y_var_logScale = TRUE,
                bin_heatmap    = FALSE,
                markLines_list = list(cohort = c(1898,1903,1908,1913,
                                                 1918,1923,1928,1933,
                                                 1938,1943,1948,1953,
                                                 1958,1963,1968,1973,
                                                 1978,1983,1988,1993,
                                                 1998,2003,2008,2013,
                                                 2018)))
```

## 5. Análisis descriptivo con gráfico tridimensional

-   Gráfico tridimensional sin etiquetas

```{r}
bd_long_dm_m$age_group_numeric <- as.numeric(as.factor(bd_long_dm_m$age_group))
bd_long_dm_m$period_group_numeric <- as.numeric(as.factor(bd_long_dm_m$period_group))
bd_long_dm_m$cohort_group_numeric <- as.numeric(as.factor(bd_long_dm_m$cohort_group))

bd_long_dm_m$mortality_rate_log <- log10(bd_long_dm_m$mortality_rate)

plot3D_1_m <- plot_ly(bd_long_dm_m, 
                x = ~age_group_numeric, 
                y = ~period_group_numeric, 
                z = ~cohort_group_numeric, 
                type = "scatter3d", 
                mode = "markers", 
                color = ~mortality_rate_log,
                marker = list(colorscale = "Viridis", 
                              cmin = min(bd_long_dm_h$mortality_rate_log), 
                              cmax = max(bd_long_dm_h$mortality_rate_log),  
                              colorbar = list(title = "log10 Mortality Rate"))) %>%
  layout(scene = list(xaxis = list(title = 'Age Group'),
                      yaxis = list(title = 'Period Group'),
                      zaxis = list(title = 'Cohort Group'),
                      aspectmode = "cube"), 
         title = "Gráfico 3D Mortalidad de diabetes mellitus por Grupos de Edad, Periodo y Cohorte en mujeres")

plot3D_1_m
```

-   Gráfico tridimensional con etiquetas

```{r}
age_group_labels_m <- c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", 
                      "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", 
                      "60-64", "65-69", "70-74", "75-79", "80-84", "85+")

period_group_labels_m <- c("1983-1987", "1988-1992", "1993-1997", 
                         "1998-2002", "2003-2007", "2008-2012", 
                         "2013-2017", "2018-2022")

cohort_group_labels_m <- c("1898-1902", "1903-1907", "1908-1912", 
                         "1913-1917", "1918-1922", "1923-1927", 
                         "1928-1932", "1933-1937", "1938-1942", 
                         "1943-1947", "1948-1952", "1953-1957", 
                         "1958-1962", "1963-1967", "1968-1972", 
                         "1973-1977", "1978-1982", "1983-1987", 
                         "1988-1992", "1993-1997", "1998-2002", 
                         "2003-2007", "2008-2012", "2013-2017", 
                         "2018-2022")

plot3D_2_m <- plot_ly(bd_long_dm_m, 
                x = ~age_group_numeric, 
                y = ~period_group_numeric, 
                z = ~cohort_group_numeric, 
                type = "scatter3d", 
                mode = "markers", 
                color = ~mortality_rate_log,
                marker = list(colorscale = "Viridis", 
                              cmin = min(bd_long_dm_m$mortality_rate_log), 
                              cmax = max(bd_long_dm_m$mortality_rate_log),  
                              colorbar = list(title = "log10 Mortality Rate"))) %>%
  layout(scene = list(xaxis = list(title = 'Age Group', tickvals = 1:length(age_group_labels_m), ticktext = age_group_labels_m),
                      yaxis = list(title = 'Period Group', tickvals = 1:length(period_group_labels_m), ticktext = period_group_labels_m),
                      zaxis = list(title = 'Cohort Group', tickvals = 1:length(cohort_group_labels_m), ticktext = cohort_group_labels_m),
                      aspectmode = "cube"),
         title = "Gráfico 3D Mortalidad de diabetes mellitus por Grupos de Edad, Periodo y Cohorte en mujeres")

plot3D_2_m
```

## 6. Modelos de regresión de quasi-poisson simples

-   Organizar las bases de datos de tabla de Lexis en formato edad\*periodo con las respectivas etiquetas

```{r, warning=FALSE}
bd_lexis_f_dm_a_p_m <- apcheader(r=bd_lexis_f_dm_m, 
                               agestart=0, 
                               yearstart=1983, 
                               agespan=5, 
                               yearspan=5, 
                               head=F)
```

```{r, warning=FALSE}
bd_lexis_p_dm_a_p_m <- apcheader(r=bd_lexis_p_dm_m, 
                               agestart=0, 
                               yearstart=1983, 
                               agespan=5, 
                               yearspan=5, 
                               head=F)
```

```{r, warning=FALSE}
bd_lexis_t_dm_a_p_m <- apcheader(r=bd_lexis_t_dm_m, 
                               agestart=0, 
                               yearstart=1983, 
                               agespan=5, 
                               yearspan=5, 
                               head=F)
```

**Modelo simple del efecto de la edad, como variable independiente, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_A_m <- apcglmfit(r=bd_lexis_t_dm_a_p_m, header=T, n.risk= bd_lexis_p_dm_a_p_m, Scale=1e-5, apcmodel="A", fam="qlik", Plot=T)
model_A_m
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_A_m)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_A_m <- model_A_m$parameter[, "Estimate"]
std_errors_model_A_m <- model_A_m$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_A_m <- parameters_model_A_m - 1.96 * std_errors_model_A_m
conf_int_upper_model_A_m <- parameters_model_A_m + 1.96 * std_errors_model_A_m

# Mostrar los intervalos de confianza
conf_int_model_A_m <- data.frame(lower = conf_int_lower_model_A_m, upper = conf_int_upper_model_A_m)
conf_int_model_A_m
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_A_m <- exp(model_A_m$parameter[, "Estimate"])
coef_exp_model_A_m <- round(coef_exp_model_A_m, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_A_m <- exp(model_A_m$parameter[, "Estimate"] - 1.96 * model_A_m$parameter[, "Std. Error"])
conf_int_lower_exp_model_A_m <- round(conf_int_lower_exp_model_A_m, 2)

conf_int_upper_exp_model_A_m <- exp(model_A_m$parameter[, "Estimate"] + 1.96 * model_A_m$parameter[, "Std. Error"])
conf_int_upper_exp_model_A_m <- round(conf_int_upper_exp_model_A_m, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_A_m <- data.frame(Rate_Ratio = coef_exp_model_A_m,
                          lower = conf_int_lower_exp_model_A_m,
                          upper = conf_int_upper_exp_model_A_m)

# Mostrar los resultados
results_exp_model_A_m
```

**Modelo simple del efecto del período, como variable independiente, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_P_m <- apcglmfit(r=bd_lexis_t_dm_a_p_m, header=T, n.risk= bd_lexis_p_dm_a_p_m, Scale=1e-5, apcmodel="P", fam="qlik", Plot=T)
model_P_m
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_P_m)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_P_m <- model_P_m$parameter[, "Estimate"]
std_errors_model_P_m <- model_P_m$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_P_m <- parameters_model_P_m - 1.96 * std_errors_model_P_m
conf_int_upper_model_P_m <- parameters_model_P_m + 1.96 * std_errors_model_P_m

# Mostrar los intervalos de confianza
conf_int_model_P_m <- data.frame(lower = conf_int_lower_model_P_m, upper = conf_int_upper_model_P_m)
conf_int_model_P_m
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_P_m <- exp(model_P_m$parameter[, "Estimate"])
coef_exp_model_P_m <- round(coef_exp_model_P_m, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_P_m <- exp(model_P_m$parameter[, "Estimate"] - 1.96 * model_P_m$parameter[, "Std. Error"])
conf_int_lower_exp_model_P_m <- round(conf_int_lower_exp_model_P_m, 2)

conf_int_upper_exp_model_P_m <- exp(model_P_m$parameter[, "Estimate"] + 1.96 * model_P_m$parameter[, "Std. Error"])
conf_int_upper_exp_model_P_m <- round(conf_int_upper_exp_model_P_m, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_P_m <- data.frame(Rate_Ratio = coef_exp_model_P_m,
                          lower = conf_int_lower_exp_model_P_m,
                          upper = conf_int_upper_exp_model_P_m)

# Mostrar los resultados
results_exp_model_P_m
```

**Modelo simple del efecto de la cohorte, como variable independiente, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_C_m <- apcglmfit(r=bd_lexis_t_dm_a_p_m, header=T, n.risk= bd_lexis_p_dm_a_p_m, Scale=1e-5, apcmodel="C", fam="qlik", Plot=T)
model_C_m
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_C_m)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_C_m <- model_C_m$parameter[, "Estimate"]
std_errors_model_C_m <- model_C_m$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_C_m <- parameters_model_C_m - 1.96 * std_errors_model_C_m
conf_int_upper_model_C_m <- parameters_model_C_m + 1.96 * std_errors_model_C_m

# Mostrar los intervalos de confianza
conf_int_model_C_m <- data.frame(lower = conf_int_lower_model_C_m, upper = conf_int_upper_model_C_m)
conf_int_model_C_m
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_C_m <- exp(model_C_m$parameter[, "Estimate"])
coef_exp_model_C_m <- round(coef_exp_model_C_m, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_C_m <- exp(model_C_m$parameter[, "Estimate"] - 1.96 * model_C_m$parameter[, "Std. Error"])
conf_int_lower_exp_model_C_m <- round(conf_int_lower_exp_model_C_m, 2)

conf_int_upper_exp_model_C_m <- exp(model_C_m$parameter[, "Estimate"] + 1.96 * model_C_m$parameter[, "Std. Error"])
conf_int_upper_exp_model_C_m <- round(conf_int_upper_exp_model_C_m, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_C_m <- data.frame(Rate_Ratio = coef_exp_model_C_m,
                          lower = conf_int_lower_exp_model_C_m,
                          upper = conf_int_upper_exp_model_C_m)

# Mostrar los resultados
results_exp_model_C_m
```

-   Medidas de bondad de ajuste de los modelos de regresión quasi-poisson simples

| Modelo  | Deviance | Grados de libertad | Parámetro de dispersión |
|---------|----------|--------------------|-------------------------|
| Edad    | 9270,399 | 126                | 71,98189                |
| Periodo | 486184,1 | 136                | 9290,052                |
| Cohorte | 84378,55 | 119                | 730,2568                |

## 7. Modelos de regresión de quasi-poisson múltiples:

**Modelo múltiple del efecto de la edad y el período, como variables independientes, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_AP_m <- apcglmfit(r=bd_lexis_t_dm_a_p_m, header=T, n.risk= bd_lexis_p_dm_a_p_m, Scale=1e-5, apcmodel="AP", fam="qlik", Plot=T)
model_AP_m
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_AP_m)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_AP_m <- model_AP_m$parameter[, "Estimate"]
std_errors_model_AP_m <- model_AP_m$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_AP_m <- parameters_model_AP_m - 1.96 * std_errors_model_AP_m
conf_int_upper_model_AP_m <- parameters_model_AP_m + 1.96 * std_errors_model_AP_m

# Mostrar los intervalos de confianza
conf_int_model_AP_m <- data.frame(lower = conf_int_lower_model_AP_m, upper = conf_int_upper_model_AP_m)
conf_int_model_AP_m
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_AP_m <- exp(model_AP_m$parameter[, "Estimate"])
coef_exp_model_AP_m <- round(coef_exp_model_AP_m, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_AP_m <- exp(model_AP_m$parameter[, "Estimate"] - 1.96 * model_AP_m$parameter[, "Std. Error"])
conf_int_lower_exp_model_AP_m <- round(conf_int_lower_exp_model_AP_m, 2)

conf_int_upper_exp_model_AP_m <- exp(model_AP_m$parameter[, "Estimate"] + 1.96 * model_AP_m$parameter[, "Std. Error"])
conf_int_upper_exp_model_AP_m <- round(conf_int_upper_exp_model_AP_m, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_AP_m <- data.frame(Rate_Ratio = coef_exp_model_AP_m,
                          lower = conf_int_lower_exp_model_AP_m,
                          upper = conf_int_upper_exp_model_AP_m)

# Mostrar los resultados
results_exp_model_AP_m
```

**Modelo múltiple del efecto de la edad y la cohorte, como variables independientes, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_AC_m <- apcglmfit(r=bd_lexis_t_dm_a_p_m, header=T, n.risk= bd_lexis_p_dm_a_p_m, Scale=1e-5, apcmodel="AC", fam="qlik", Plot=T)
model_AC_m
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_AC_m)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_AC_m <- model_AC_m$parameter[, "Estimate"]
std_errors_model_AC_m <- model_AC_m$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_AC_m <- parameters_model_AC_m - 1.96 * std_errors_model_AC_m
conf_int_upper_model_AC_m <- parameters_model_AC_m + 1.96 * std_errors_model_AC_m

# Mostrar los intervalos de confianza
conf_int_model_AC_m <- data.frame(lower = conf_int_lower_model_AC_m, upper = conf_int_upper_model_AC_m)
conf_int_model_AC_m
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_AC_m <- exp(model_AC_m$parameter[, "Estimate"])
coef_exp_model_AC_m <- round(coef_exp_model_AC_m, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_AC_m <- exp(model_AC_m$parameter[, "Estimate"] - 1.96 * model_AC_m$parameter[, "Std. Error"])
conf_int_lower_exp_model_AC_m <- round(conf_int_lower_exp_model_AC_m, 2)

conf_int_upper_exp_model_AC_m <- exp(model_AC_m$parameter[, "Estimate"] + 1.96 * model_AC_m$parameter[, "Std. Error"])
conf_int_upper_exp_model_AC_m <- round(conf_int_upper_exp_model_AC_m, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_AC_m <- data.frame(Rate_Ratio = coef_exp_model_AC_m,
                          lower = conf_int_lower_exp_model_AC_m,
                          upper = conf_int_upper_exp_model_AC_m)

# Mostrar los resultados
results_exp_model_AC_m
```

-   Medidas de bondad de ajuste de los modelos de regresión quasi-poisson simples y múltiples

+--------------+--------------+--------------------+-------------------------+
| Modelo       | Deviance     | Grados de libertad | Parámetro de dispersión |
+==============+==============+====================+=========================+
| Edad         | 9270,399     | 126                | 71,98189                |
+--------------+--------------+--------------------+-------------------------+
| Período      | 486184,1     | 136                | 9290,052                |
+--------------+--------------+--------------------+-------------------------+
| Cohorte      | 84378,55     | 119                | 730,2568                |
+--------------+--------------+--------------------+-------------------------+
| Edad-Período | 3964,67      | 119                | 31,4119                 |
+--------------+--------------+--------------------+-------------------------+
| Edad-Cohorte | 2570,77      | 102                | 25,56509                |
+--------------+--------------+--------------------+-------------------------+

## **8. Modelo de regresión de quasi-poisson multiple completo y gráficos de los efectos ajustados**

**Modelo múltiple del efecto de la edad, el período y la cohorte, como variables independientes, sobre los casos esperados de fallecimiento de diabetes mellitus, como variable dependiente, y la población expuesta, como término de compensación:**

-   *Modelo de regresión quasi-poisson:*

```{r}
model_APC_m <- apcglmfit(r=bd_lexis_t_dm_a_p_m, header=T, n.risk= bd_lexis_p_dm_a_p_m, Scale=1e-5, apcmodel="APC", fam="qlik", Plot=T)
model_APC_m
```

-   *Estructura del modelo de regresión:*

```{r}
str(model_APC_m)
```

-   *Intervalos de confianza del 95% de los coeficientes de regresión:*

```{r}
# Extraer los parámetros y los errores estándar del modelo
parameters_model_APC_m <- model_APC_m$parameter[, "Estimate"]
std_errors_model_APC_m <- model_APC_m$parameter[, "Std. Error"]

# Calcular los intervalos de confianza del 95%
conf_int_lower_model_APC_m <- parameters_model_APC_m - 1.96 * std_errors_model_APC_m
conf_int_upper_model_APC_m <- parameters_model_APC_m + 1.96 * std_errors_model_APC_m

# Mostrar los intervalos de confianza
conf_int_model_APC_m <- data.frame(lower = conf_int_lower_model_APC_m, upper = conf_int_upper_model_APC_m)
conf_int_model_APC_m
```

-   *Razón de tasas de mortalidad e intervalos de confianza del 95%:*

```{r}
# Exponenciar los coeficientes de regresión
coef_exp_model_APC_m <- exp(model_APC_m$parameter[, "Estimate"])
coef_exp_model_APC_m <- round(coef_exp_model_APC_m, 2)

# Exponenciar los límites de los intervalos de confianza
conf_int_lower_exp_model_APC_m <- exp(model_APC_m$parameter[, "Estimate"] - 1.96 * model_APC_m$parameter[, "Std. Error"])
conf_int_lower_exp_model_APC_m <- round(conf_int_lower_exp_model_APC_m, 2)

conf_int_upper_exp_model_APC_m <- exp(model_APC_m$parameter[, "Estimate"] + 1.96 * model_APC_m$parameter[, "Std. Error"])
conf_int_upper_exp_model_APC_m <- round(conf_int_upper_exp_model_APC_m, 2)

# Crear un data frame con los resultados exponenciados
results_exp_model_APC_m <- data.frame(Rate_Ratio = coef_exp_model_APC_m,
                          lower = conf_int_lower_exp_model_APC_m,
                          upper = conf_int_upper_exp_model_APC_m)

# Mostrar los resultados
results_exp_model_APC_m
```

-   *Gráfico efectos de la edad*

```{r}
edad_mujeres <- readxl::read_excel("resultados_modelo_mujeres_edad.xlsx")

edad_mujeres$grupo <- edad_mujeres$grupo |> 
  replace_na() |> 
  factor(ordered = T, levels = c(
    "0-4", "5-9", "10-14", "15-19", "20-24", "25-29", 
    "30-34", "35-39", "40-44", "45-49", 
    "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+") )
edad_mujeres

ggplot(edad_mujeres, aes(x=grupo, y=estimador, group = 1)) +
  geom_ribbon(aes(ymin=ic_liminf, ymax=ic_limsup), fill = "lightblue", alpha = 0.5) +
  geom_point(color="blue", size = 3) +
  geom_line(color = "blue", size = 1, linetype = "dashed") +
  labs(x="Grupo de edad", y="Coeficiente de regresión", 
       title="Efectos de la edad en la mortalidad por DM en mujeres (A)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 16),
        legend.position = "none")
```

-   *Gráfico efectos del período*

```{r}
periodo_mujeres <- readxl::read_excel("resultados_modelo_mujeres_periodo.xlsx")

periodo_mujeres$grupo <- periodo_mujeres$grupo |> 
  replace_na() |> 
  factor(ordered = T, levels = c(
    "1983-1987", "1988-1992", "1993-1997", 
    "1998-2002", "2003-2007", "2008-2012", 
    "2013-2017", "2018-2022") )
periodo_mujeres

ggplot(periodo_mujeres, aes(x=grupo, y=estimador, group = 1)) +
  geom_ribbon(aes(ymin=ic_liminf, ymax=ic_limsup), fill = "salmon", alpha = 0.5) +
  geom_point(color="red", size = 3) +
  geom_line(color = "red", size = 1, linetype = "dashed") +
  labs(x="Grupo de periodo", y="Coeficiente de regresión", 
       title="Efectos del periodo en la mortalidad por DM en mujeres (B)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 16),
        legend.position = "none")
```

-   *Gráfico efectos de la cohorte*

```{r}
cohorte_mujeres <- readxl::read_excel("resultados_modelo_mujeres_cohorte.xlsx")

cohorte_mujeres$grupo <- cohorte_mujeres$grupo |> 
  replace_na() |> 
  factor(ordered = T, levels = c(
    "1898-1902", "1903-1907", "1908-1912", 
    "1913-1917", "1918-1922",
    "1923-1927", "1928-1932", "1933-1937",
    "1938-1942", "1943-1947",
    "1948-1952", "1953-1957", "1958-1962", 
    "1963-1967", "1968-1972",
    "1973-1977", "1978-1982", "1983-1987", 
    "1988-1992", "1993-1997",
    "1998-2002", "2003-2007", "2008-2012", 
    "2013-2017", "2018-2022") )
cohorte_mujeres

ggplot(cohorte_mujeres, aes(x=grupo, y=estimador, group = 1)) +
  geom_ribbon(aes(ymin=ic_liminf, ymax=ic_limsup), fill = "lightgreen", alpha = 0.5) +
  geom_point(color="green", size = 3) +
  geom_line(color = "green", size = 1, linetype = "dashed") +
  labs(x="Grupo de cohorte", y="Coeficiente de regresión", 
       title="Efectos de la cohorte en la mortalidad por DM en mujeres (C)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 16),
        axis.text.y = element_text(size = 16),
        plot.title = element_text(size = 16, face = "bold"),
        axis.title = element_text(size = 16),
        legend.position = "none")
```

-   Medidas de bondad de ajuste de los modelos de regresión quasi-poisson simples y múltiples

+----------------------+--------------+--------------------+-------------------------+
| Modelo               | Deviance     | Grados de libertad | Parámetro de dispersión |
+======================+==============+====================+=========================+
| Edad                 | 9270,399     | 126                | 71,98189                |
+----------------------+--------------+--------------------+-------------------------+
| Período              | 486184,1     | 136                | 9290,052                |
+----------------------+--------------+--------------------+-------------------------+
| Cohorte              | 84378,55     | 119                | 730,2568                |
+----------------------+--------------+--------------------+-------------------------+
| Edad-Período         | 3964,67      | 119                | 31,4119                 |
+----------------------+--------------+--------------------+-------------------------+
| Edad-Cohorte         | 2570,77      | 102                | 25,56509                |
+----------------------+--------------+--------------------+-------------------------+
| Edad-Período-Cohorte | 428,535      | 96                 | 4,457404                |
+----------------------+--------------+--------------------+-------------------------+

# 
